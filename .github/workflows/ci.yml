name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'

# Restrict permissions for security
# https://docs.github.com/en/actions/security-guides/automatic-token-authentication
permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Security audit
        run: pnpm audit --audit-level=high

      - name: Type check - Site
        working-directory: packages/site
        run: pnpm run typecheck

      - name: Type check - Infra
        working-directory: packages/infra
        run: pnpm run typecheck

      - name: Type check - Content Pipeline
        working-directory: packages/content-pipeline
        run: pnpm run typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run site tests
        working-directory: packages/site
        run: pnpm test

      - name: Run infra tests
        working-directory: packages/infra
        run: pnpm test

      - name: Run content-pipeline tests
        working-directory: packages/content-pipeline
        run: pnpm test

  build:
    name: Build Site
    runs-on: ubuntu-latest
    needs: [validate, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build content pipeline
        working-directory: packages/content-pipeline
        run: pnpm run build

      - name: Build site
        working-directory: packages/site
        run: pnpm run build
        env:
          SITE_URL: https://example.com

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: site-dist
          path: packages/site/dist/
          retention-days: 7

  # Note: CDK synth requires AWS credentials for Route53 lookups
  # Full CDK validation happens in the Deploy workflow with OIDC credentials
