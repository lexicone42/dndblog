name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

# Required for OIDC authentication with AWS
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    # Only run on the main repository, never on forks
    if: github.repository == 'lexicone42/dndblog'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: us-east-1
          role-session-name: github-actions-deploy

      - name: Deploy DM Notes API
        id: dm-notes
        working-directory: packages/infra
        run: |
          npx cdk deploy DmNotesStack \
            --require-approval never \
            --outputs-file dm-notes-outputs.json \
            --context domainName="${DOMAIN_NAME}" \
            --context hostedZoneDomain="${HOSTED_ZONE_DOMAIN}"

          # Extract API URL and WebSocket URL for site build
          API_URL=$(jq -r '.DmNotesStack.ApiUrlOutput' dm-notes-outputs.json)
          WS_URL=$(jq -r '.DmNotesStack.WebSocketUrlOutput' dm-notes-outputs.json)
          echo "api_url=$API_URL" >> "$GITHUB_OUTPUT"
          echo "ws_url=$WS_URL" >> "$GITHUB_OUTPUT"
        env:
          DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
          HOSTED_ZONE_DOMAIN: ${{ vars.HOSTED_ZONE_DOMAIN }}

      - name: Deploy Auth Stack
        id: auth
        working-directory: packages/infra
        run: |
          npx cdk deploy AuthStack \
            --require-approval never \
            --outputs-file auth-outputs.json \
            --context domainName="${DOMAIN_NAME}" \
            --context hostedZoneDomain="${HOSTED_ZONE_DOMAIN}"

          # Extract Cognito config for site build
          USER_POOL_ID=$(jq -r '.AuthStack.UserPoolId' auth-outputs.json)
          CLIENT_ID=$(jq -r '.AuthStack.UserPoolClientId' auth-outputs.json)
          COGNITO_DOMAIN=$(jq -r '.AuthStack.CognitoDomainOutput' auth-outputs.json)
          echo "user_pool_id=$USER_POOL_ID" >> "$GITHUB_OUTPUT"
          echo "client_id=$CLIENT_ID" >> "$GITHUB_OUTPUT"
          echo "cognito_domain=$COGNITO_DOMAIN" >> "$GITHUB_OUTPUT"
        env:
          DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
          HOSTED_ZONE_DOMAIN: ${{ vars.HOSTED_ZONE_DOMAIN }}

      - name: Build content pipeline
        working-directory: packages/content-pipeline
        run: pnpm run build

      - name: Build site
        working-directory: packages/site
        run: pnpm run build
        env:
          SITE_URL: https://${{ vars.DOMAIN_NAME }}
          PUBLIC_DM_NOTES_API_URL: ${{ steps.dm-notes.outputs.api_url }}
          PUBLIC_WS_URL: ${{ steps.dm-notes.outputs.ws_url }}
          PUBLIC_COGNITO_USER_POOL_ID: ${{ steps.auth.outputs.user_pool_id }}
          PUBLIC_COGNITO_CLIENT_ID: ${{ steps.auth.outputs.client_id }}
          PUBLIC_COGNITO_DOMAIN: ${{ steps.auth.outputs.cognito_domain }}
          PUBLIC_AUTH_MODE: dual

      - name: CDK deploy
        working-directory: packages/infra
        run: |
          npx cdk deploy StaticSiteStack \
            --require-approval never \
            --outputs-file cdk-outputs.json \
            --context domainName="${DOMAIN_NAME}" \
            --context hostedZoneDomain="${HOSTED_ZONE_DOMAIN}"
        env:
          DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
          HOSTED_ZONE_DOMAIN: ${{ vars.HOSTED_ZONE_DOMAIN }}

      - name: Extract CDK outputs
        id: outputs
        working-directory: packages/infra
        run: |
          BUCKET_NAME=$(jq -r '.StaticSiteStack.SiteBucketNameOutput' cdk-outputs.json)
          DISTRIBUTION_ID=$(jq -r '.StaticSiteStack.DistributionIdOutput' cdk-outputs.json)
          echo "bucket_name=$BUCKET_NAME" >> "$GITHUB_OUTPUT"
          echo "distribution_id=$DISTRIBUTION_ID" >> "$GITHUB_OUTPUT"

      - name: Sync to S3
        run: |
          # Sync non-HTML files with long cache
          aws s3 sync packages/site/dist/ "s3://${BUCKET_NAME}" \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"

          # Sync HTML files with no cache
          aws s3 sync packages/site/dist/ "s3://${BUCKET_NAME}" \
            --cache-control "public, max-age=0, must-revalidate" \
            --include "*.html"
        env:
          BUCKET_NAME: ${{ steps.outputs.outputs.bucket_name }}

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${DISTRIBUTION_ID}" \
            --paths "/*"
        env:
          DISTRIBUTION_ID: ${{ steps.outputs.outputs.distribution_id }}

      - name: Output deployment URL
        run: |
          echo "## Deployment Complete :rocket:" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Site URL:** https://${DOMAIN_NAME}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**CloudFront Distribution:** ${DISTRIBUTION_ID}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "_Note: DNS propagation and CDN may take a few minutes to fully update._" >> "$GITHUB_STEP_SUMMARY"
        env:
          DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
          DISTRIBUTION_ID: ${{ steps.outputs.outputs.distribution_id }}

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Install Playwright browsers
        working-directory: packages/site
        run: npx playwright install chromium

      - name: Wait for CDN propagation
        run: sleep 60

      - name: Run smoke tests
        working-directory: packages/site
        run: pnpm test:smoke
        env:
          SITE_URL: https://${{ vars.DOMAIN_NAME }}

      - name: Upload Playwright report on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: packages/site/playwright-report/
          retention-days: 7
