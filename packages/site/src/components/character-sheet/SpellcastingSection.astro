---
/**
 * SpellcastingSection.astro
 * Displays spellcasting ability, slots, cantrips, and prepared/known spells.
 * Supports both standard slots and Warlock Pact Magic.
 */

import RuleTerm from '../RuleTerm.astro';

interface GlossaryEntry {
  name: string;
  slug: string;
  description: string;
  category?: string;
}

interface SpellSlot {
  level: number;
  total: number;
  expended?: number;
}

interface PactSlot {
  level: number;
  total: number;
  expended?: number;
}

interface Props {
  spellcasting?: {
    ability?: 'int' | 'wis' | 'cha';
    spellSaveDC?: number;
    spellAttackBonus?: number;
    spellSlots?: SpellSlot[];
    pactSlots?: PactSlot;
    cantrips?: string[];
    preparedSpells?: string[];
    knownSpells?: string[];
    spellbook?: string[];
    ritualCaster?: boolean;
  };
  spellLookup?: Record<string, { name: string; path: string; level: number; school: string }>;
  glossaryLookup?: Record<string, GlossaryEntry>;
}

const { spellcasting, spellLookup = {}, glossaryLookup = {} } = Astro.props;

if (!spellcasting) return;

const {
  ability,
  spellSaveDC,
  spellAttackBonus,
  spellSlots = [],
  pactSlots,
  cantrips = [],
  preparedSpells = [],
  knownSpells = [],
  spellbook = [],
  ritualCaster = false,
} = spellcasting;

const abilityNames: Record<string, string> = {
  int: 'Intelligence',
  wis: 'Wisdom',
  cha: 'Charisma',
};

// Format spell attack bonus
function formatBonus(bonus: number | undefined): string {
  if (bonus === undefined) return '—';
  return bonus >= 0 ? `+${bonus}` : `${bonus}`;
}

// Determine which spell list to show
const spellList = preparedSpells.length > 0 ? preparedSpells :
  knownSpells.length > 0 ? knownSpells :
  spellbook;
const spellListLabel = preparedSpells.length > 0 ? 'Prepared Spells' :
  knownSpells.length > 0 ? 'Known Spells' :
  spellbook.length > 0 ? 'Spellbook' : 'Spells';

// Check if we have meaningful spellcasting data
const hasSpellcasting = ability || spellSlots.length > 0 || pactSlots || cantrips.length > 0 || spellList.length > 0;

// Get color based on slot usage percentage
function getSlotColor(available: number, total: number): string {
  if (total === 0) return 'var(--color-text-muted)';
  const percent = (available / total) * 100;
  if (percent > 75) return 'var(--color-success)'; // Green - plenty left
  if (percent > 25) return 'var(--color-warning)'; // Yellow/Orange - getting low
  return 'var(--color-error)'; // Red - nearly depleted
}

// Format slot level as ordinal
function formatOrdinal(n: number): string {
  const suffixes = ['th', 'st', 'nd', 'rd'];
  const v = n % 100;
  return n + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
}
---

{hasSpellcasting && (
  <section class="spellcasting-section">
    <h3 class="spellcasting-section__title">Spellcasting</h3>

    <!-- Spellcasting Stats -->
    <div class="spellcasting-stats">
      {ability && (
        <div class="spell-stat">
          <span class="spell-stat__label">Ability</span>
          <span class="spell-stat__value">{abilityNames[ability]}</span>
        </div>
      )}
      {spellSaveDC && (
        <div class="spell-stat">
          <span class="spell-stat__label">Spell Save DC</span>
          <span class="spell-stat__value spell-stat__value--highlight">{spellSaveDC}</span>
        </div>
      )}
      {spellAttackBonus !== undefined && (
        <div class="spell-stat">
          <span class="spell-stat__label">Spell Attack</span>
          <span class="spell-stat__value spell-stat__value--highlight">{formatBonus(spellAttackBonus)}</span>
        </div>
      )}
      {ritualCaster && (
        <div class="spell-stat spell-stat--badge">
          <span class="ritual-badge">
            <RuleTerm term="Ritual" lookup={glossaryLookup}>Ritual Caster</RuleTerm>
          </span>
        </div>
      )}
    </div>

    <!-- Spell Slots -->
    {spellSlots.length > 0 && (
      <div class="spell-slots">
        <h4 class="spell-subtitle">Spell Slots</h4>
        <div class="slots-grid">
          {spellSlots.map(({ level, total, expended = 0 }) => {
            const available = total - expended;
            const slotColor = getSlotColor(available, total);
            return (
              <div class="slot-level" style={`--slot-color: ${slotColor}`}>
                <span class="slot-level__badge">{level}</span>
                <span class="slot-level__label">{formatOrdinal(level)} Level</span>
                <div class="slot-pips">
                  {Array.from({ length: total }).map((_, i) => (
                    <span class={`slot-pip ${i < available ? 'slot-pip--available' : 'slot-pip--expended'}`}>
                      {i < available ? '●' : '○'}
                    </span>
                  ))}
                </div>
                <span class="slot-count">{available}/{total}</span>
              </div>
            );
          })}
        </div>
      </div>
    )}

    <!-- Pact Slots (Warlock) -->
    {pactSlots && (() => {
      const pactAvailable = pactSlots.total - (pactSlots.expended ?? 0);
      const pactColor = getSlotColor(pactAvailable, pactSlots.total);
      return (
        <div class="pact-slots" style={`--slot-color: ${pactColor}`}>
          <h4 class="spell-subtitle">
            <span class="pact-magic-label">Pact Magic</span>
          </h4>
          <div class="pact-info">
            <span class="pact-level-badge">{pactSlots.level}</span>
            <span class="pact-level">{formatOrdinal(pactSlots.level)} Level</span>
            <div class="slot-pips slot-pips--pact">
              {Array.from({ length: pactSlots.total }).map((_, i) => (
                <span class={`slot-pip slot-pip--pact ${i < pactAvailable ? 'slot-pip--available' : 'slot-pip--expended'}`}>
                  {i < pactAvailable ? '●' : '○'}
                </span>
              ))}
            </div>
            <span class="slot-count">{pactAvailable}/{pactSlots.total}</span>
            <span class="pact-recharge">Recovers on Short Rest</span>
          </div>
        </div>
      );
    })()}

    <!-- Cantrips -->
    {cantrips.length > 0 && (
      <div class="spell-list">
        <h4 class="spell-subtitle">
          <RuleTerm term="Cantrip" lookup={glossaryLookup}>Cantrips</RuleTerm>
        </h4>
        <ul class="spells">
          {cantrips.map((spell) => {
            const spellData = spellLookup[spell];
            return (
              <li class="spell spell--cantrip">
                {spellData ? (
                  <a href={spellData.path} class="spell-link spell-link--cantrip">{spell}</a>
                ) : (
                  spell
                )}
              </li>
            );
          })}
        </ul>
      </div>
    )}

    <!-- Prepared/Known Spells or Spellbook -->
    {spellList.length > 0 && (
      <div class="spell-list">
        <h4 class="spell-subtitle">
          {preparedSpells.length > 0 ? (
            <RuleTerm term="Prepared Spells" lookup={glossaryLookup}>Prepared Spells</RuleTerm>
          ) : spellListLabel}
        </h4>
        <ul class="spells">
          {spellList.map((spell) => {
            const spellData = spellLookup[spell];
            return (
              <li class="spell">
                {spellData ? (
                  <a href={spellData.path} class="spell-link">{spell}</a>
                ) : (
                  spell
                )}
              </li>
            );
          })}
        </ul>
      </div>
    )}
  </section>
)}

<style>
  .spellcasting-section {
    margin-bottom: var(--space-xl);
    background: var(--color-bg-secondary);
    border: 2px solid var(--color-accent);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
  }

  .spellcasting-section__title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    color: var(--color-accent);
    margin: 0 0 var(--space-md);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .spellcasting-stats {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--color-border);
  }

  .spell-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: var(--color-bg);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
  }

  .spell-stat--badge {
    background: transparent;
  }

  .spell-stat__label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    margin-bottom: 2px;
  }

  .spell-stat__value {
    font-size: var(--text-md);
    font-weight: 600;
    color: var(--color-text);
  }

  .spell-stat__value--highlight {
    font-size: var(--text-xl);
    color: var(--color-accent);
  }

  .ritual-badge {
    font-size: var(--text-xs);
    background: var(--color-accent);
    color: white;
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    font-weight: 600;
  }

  .spell-subtitle {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    text-transform: uppercase;
    margin: 0 0 var(--space-sm);
    font-weight: 600;
  }

  .spell-slots,
  .pact-slots,
  .spell-list {
    margin-bottom: var(--space-md);
  }

  .slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: var(--space-sm);
  }

  .slot-level {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: var(--color-bg);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    border: 2px solid var(--slot-color, var(--color-border));
    transition: border-color var(--transition-fast);
  }

  .slot-level__badge {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--slot-color, var(--color-accent));
    color: white;
    font-weight: 700;
    font-size: var(--text-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--space-xs);
  }

  .slot-level__label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .slot-pips {
    display: flex;
    gap: 4px;
    margin-bottom: 4px;
  }

  .slot-pip {
    font-size: var(--text-lg);
    line-height: 1;
  }

  .slot-pip--available {
    color: var(--slot-color, var(--color-accent));
  }

  .slot-pip--expended {
    color: var(--color-text-muted);
    opacity: 0.4;
  }

  .slot-pips--pact .slot-pip--available {
    color: var(--slot-color, var(--color-warning));
  }

  .slot-count {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    font-weight: 600;
  }

  .pact-slots {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, transparent 100%);
    padding: var(--space-sm);
    border-radius: var(--radius-md);
    border: 2px solid var(--slot-color, var(--color-warning));
  }

  .pact-magic-label {
    color: var(--color-warning);
    font-weight: 700;
  }

  .pact-info {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-sm);
    background: var(--color-bg);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
  }

  .pact-level-badge {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--slot-color, var(--color-warning));
    color: white;
    font-weight: 700;
    font-size: var(--text-md);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .pact-level {
    font-weight: 600;
    color: var(--color-text);
  }

  .pact-recharge {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    font-style: italic;
  }

  .spells {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .spell {
    background: var(--color-bg);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: var(--text-sm);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .spell--cantrip {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .spell-link {
    color: inherit;
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .spell-link:hover {
    color: var(--color-gold);
    text-decoration: underline;
  }

  .spell-link--cantrip {
    color: var(--color-accent);
  }

  .spell-link--cantrip:hover {
    color: var(--color-gold);
  }
</style>
