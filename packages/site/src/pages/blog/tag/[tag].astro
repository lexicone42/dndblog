---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import PostCard from '@components/PostCard.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }: { data: { draft?: boolean; visibility?: string } }) => {
    return !data.draft && data.visibility === 'public';
  });

  // Type for blog entries
  type BlogEntry = typeof posts[0];

  // Get all unique tags
  const tags: string[] = [...new Set(posts.flatMap((post: BlogEntry) => post.data.tags))].filter((t): t is string => typeof t === 'string');

  return tags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts.filter((post: BlogEntry) => post.data.tags?.includes(tag)),
    },
  }));
}

// Type for blog entries (redefined at page scope)
const allPostsForType = await getCollection('blog');
type BlogEntry = typeof allPostsForType[0];

const { tag, posts } = Astro.props as { tag: string; posts: BlogEntry[] };

// Sort by date (newest first)
const sortedPosts = posts.sort(
  (a: BlogEntry, b: BlogEntry) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Calculate reading time
function getReadingTime(content: string): number {
  const words = content.split(/\s+/).length;
  return Math.ceil(words / 200);
}

// Get all tags for the navigation
const allPosts = await getCollection('blog', ({ data }: { data: { draft?: boolean; visibility?: string } }) => {
  return !data.draft && data.visibility === 'public';
});
const allTags = [...new Set(allPosts.flatMap((post: BlogEntry) => post.data.tags))].sort();
---

<BaseLayout
  title={`Posts tagged "${tag}" - Rudiger's Evocation of Events`}
  description={`Browse all posts tagged with "${tag}"`}
>
  <div class="container">
    <header class="page-header">
      <h1 class="page-title">
        <span class="page-title__label">Tag:</span>
        <span class="page-title__tag">{tag}</span>
      </h1>
      <p class="page-description">
        {sortedPosts.length} {sortedPosts.length === 1 ? 'post' : 'posts'} tagged with "{tag}"
      </p>
    </header>

    <nav class="tags-nav" aria-label="Filter by tag">
      <span class="tags-nav__label">All tags:</span>
      <ul class="tags-nav__list">
        {allTags.map((t) => (
          <li>
            <a
              href={`/blog/tag/${t}`}
              class:list={['tags-nav__tag', { 'tags-nav__tag--active': t === tag }]}
              aria-current={t === tag ? 'page' : undefined}
            >
              {t}
            </a>
          </li>
        ))}
      </ul>
    </nav>

    {sortedPosts.length > 0 ? (
      <div class="posts-grid">
        {sortedPosts.map((post: BlogEntry, index: number) => (
          <PostCard
            title={post.data.title}
            description={post.data.description}
            pubDate={post.data.pubDate}
            slug={post.id}
            heroImage={post.data.heroImage}
            tags={post.data.tags}
            readingTime={getReadingTime(post.body || '')}
            priority={index === 0}
          />
        ))}
      </div>
    ) : (
      <p class="no-posts">No posts found with this tag.</p>
    )}

    <nav class="back-nav">
      <a href="/blog" class="back-link">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        Back to Chronicles
      </a>
    </nav>
  </div>
</BaseLayout>

<style>
  .page-header {
    text-align: center;
    padding: var(--space-xl) 0 var(--space-2xl);
  }

  .page-title {
    font-size: var(--text-3xl);
    margin: 0 0 var(--space-sm);
  }

  .page-title__label {
    color: var(--color-text-muted);
    font-weight: 400;
  }

  .page-title__tag {
    color: var(--color-accent);
  }

  .page-description {
    color: var(--color-text-secondary);
    font-size: var(--text-lg);
    margin: 0;
  }

  .tags-nav {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-xl);
  }

  .tags-nav__label {
    font-weight: 600;
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
  }

  .tags-nav__list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .tags-nav__tag {
    display: inline-block;
    padding: var(--space-xs) var(--space-sm);
    background-color: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--text-sm);
    text-decoration: none;
    color: var(--color-text-secondary);
    transition: all var(--transition-fast);
  }

  .tags-nav__tag:hover {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  .tags-nav__tag--active {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-xl);
  }

  .no-posts {
    text-align: center;
    color: var(--color-text-muted);
    font-size: var(--text-lg);
    padding: var(--space-3xl);
  }

  .back-nav {
    margin-top: var(--space-2xl);
    padding-top: var(--space-xl);
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: center;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text-secondary);
    font-weight: 500;
    transition: all var(--transition-fast);
  }

  .back-link:hover {
    background-color: var(--color-bg-tertiary);
    color: var(--color-text);
  }

  @media (max-width: 640px) {
    .posts-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
