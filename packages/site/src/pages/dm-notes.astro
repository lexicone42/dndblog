---
import BaseLayout from '@layouts/BaseLayout.astro';

// Get API URL from environment variable
const apiUrl = import.meta.env.PUBLIC_DM_NOTES_API_URL || '';
---

<BaseLayout
  title="DM Notes - Rudiger's Evocation of Events"
  description="Private DM session notes editor"
>
  <!-- Load EasyMDE CSS and highlight.js for code syntax in head via fragment -->
  <Fragment slot="head">
    <link rel="stylesheet" href="https://unpkg.com/easymde@2.18.0/dist/easymde.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  </Fragment>

  <div class="dm-notes">
    <div id="access-denied" class="access-denied">
      <div class="access-denied__content">
        <h1>Access Denied</h1>
        <p>This page requires a valid access token.</p>
        <p class="access-denied__hint">Add <code>?token=your-token</code> to the URL</p>
      </div>
    </div>

    <!-- Tab Navigation -->
    <nav id="tab-navigation" class="tab-navigation" style="display: none;" role="tablist" aria-label="DM Notes sections">
      <button class="tab-btn tab-btn--active" data-tab="editor" role="tab" aria-selected="true" aria-controls="editor-container" id="tab-editor">Editor</button>
      <button class="tab-btn" data-tab="browser" role="tab" aria-selected="false" aria-controls="browser-container" id="tab-browser">Browser</button>
    </nav>

    <div id="editor-container" class="editor-container" role="tabpanel" aria-labelledby="tab-editor" style="display: none;">
      <header class="editor-header">
        <h1>DM Session Notes</h1>
        <div class="editor-header__actions">
          <span id="save-status" class="save-status">Ready</span>
          <button id="review-btn" class="btn btn--secondary">AI Review</button>
          <button id="publish-btn" class="btn btn--primary">Save</button>
        </div>
      </header>

      <div class="editor-meta">
        <label>
          Session Title:
          <input type="text" id="session-title" placeholder="Session 10: The Next Adventure" />
        </label>
      </div>

      <div class="editor-wrapper">
        <textarea id="markdown-editor"></textarea>
      </div>

      <div id="review-result" class="review-result" style="display: none;">
        <div class="review-result__header">
          <span class="review-result__score">
            Score: <strong id="review-score">--</strong>/100
          </span>
          <span id="review-status" class="review-result__status"></span>
        </div>
        <div id="review-summary" class="review-result__summary"></div>
        <ul id="review-suggestions" class="review-result__suggestions"></ul>
      </div>

      <div id="publish-result" class="publish-result" style="display: none;"></div>
    </div>

    <!-- Browser Container -->
    <div id="browser-container" class="browser-container" role="tabpanel" aria-labelledby="tab-browser" style="display: none;">
      <header class="browser-header">
        <h1>Session Notes Browser</h1>
        <div class="browser-header__controls">
          <label for="notes-search" class="visually-hidden">Search notes</label>
          <input type="search" id="notes-search" class="notes-search" placeholder="Search notes..." aria-describedby="search-hint" />
          <span id="search-hint" class="visually-hidden">Search by note title</span>
          <label for="notes-sort" class="visually-hidden">Sort notes</label>
          <select id="notes-sort" class="notes-sort" aria-label="Sort order">
            <option value="date-desc">Newest First</option>
            <option value="date-asc">Oldest First</option>
            <option value="title-asc">Title A-Z</option>
            <option value="title-desc">Title Z-A</option>
          </select>
        </div>
      </header>

      <div id="offline-indicator" class="offline-indicator" role="status" aria-live="polite" style="display: none;">
        <span class="offline-icon" aria-hidden="true">ðŸ“¡</span>
        <span>Viewing cached notes (offline mode)</span>
      </div>

      <div id="notes-loading" class="notes-loading" role="status" aria-live="polite">
        <span class="loading-spinner" aria-hidden="true"></span>
        <span>Loading notes...</span>
      </div>

      <div id="notes-error" class="notes-error" role="alert" aria-live="assertive" style="display: none;"></div>

      <div id="notes-empty" class="notes-empty" role="status" style="display: none;">
        <p>No session notes found.</p>
        <p class="notes-empty__hint">Switch to the Editor tab to create your first note!</p>
      </div>

      <div id="notes-grid" class="notes-grid" role="list" aria-label="Session notes"></div>
    </div>

    <!-- View Note Modal -->
    <div id="view-modal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="view-modal-title">
      <div class="modal__backdrop" aria-hidden="true"></div>
      <div class="modal__content modal__content--large">
        <header class="modal__header">
          <h2 id="view-modal-title">Note Title</h2>
          <button class="modal__close" data-close-modal aria-label="Close modal">&times;</button>
        </header>
        <div class="modal__meta">
          <span id="view-modal-date"></span>
          <span id="view-modal-status"></span>
        </div>
        <div id="view-modal-body" class="modal__body markdown-content" tabindex="0"></div>
        <footer class="modal__footer">
          <button id="download-note-btn" class="btn btn--secondary" aria-label="Download note as markdown file">Download</button>
          <button id="delete-note-btn" class="btn btn--danger" aria-label="Delete this note">Delete</button>
        </footer>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal" style="display: none;" role="alertdialog" aria-modal="true" aria-labelledby="delete-modal-heading" aria-describedby="delete-modal-desc">
      <div class="modal__backdrop" aria-hidden="true"></div>
      <div class="modal__content">
        <header class="modal__header">
          <h2 id="delete-modal-heading">Confirm Delete</h2>
          <button class="modal__close" data-close-modal aria-label="Cancel deletion">&times;</button>
        </header>
        <div class="modal__body">
          <p id="delete-modal-desc">Are you sure you want to delete this note?</p>
          <p id="delete-modal-title" class="delete-modal__title"></p>
          <p class="delete-modal__warning" role="alert">This action cannot be undone.</p>
        </div>
        <footer class="modal__footer">
          <button class="btn btn--secondary" data-close-modal>Cancel</button>
          <button id="confirm-delete-btn" class="btn btn--danger">Delete</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- Store API URL in a data attribute -->
  <div id="config" data-api-url={apiUrl} style="display: none;"></div>

  <!-- Load EasyMDE and Turndown (for HTML-to-Markdown paste) from CDN -->
  <script is:inline src="https://unpkg.com/easymde@2.18.0/dist/easymde.min.js"></script>
  <script is:inline src="https://unpkg.com/turndown@7.1.2/dist/turndown.js"></script>
  <!-- Markdown rendering with syntax highlighting and XSS protection -->
  <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
  <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

  <script is:inline>
    (function() {
      var STORAGE_KEY = 'dm-notes-draft';
      var TITLE_KEY = 'dm-notes-title';
      var editor = null;
      var saveTimeout = null;
      var turndownService = null;

      function getToken() {
        var params = new URLSearchParams(window.location.search);
        return params.get('token');
      }

      function getApiUrl() {
        var configEl = document.getElementById('config');
        return configEl ? configEl.dataset.apiUrl : '';
      }

      function showEditor() {
        document.getElementById('access-denied').style.display = 'none';
        document.getElementById('editor-container').style.display = 'block';
      }

      function showAccessDenied() {
        document.getElementById('access-denied').style.display = 'flex';
        document.getElementById('editor-container').style.display = 'none';
      }

      function updateSaveStatus(status, isError) {
        var el = document.getElementById('save-status');
        el.textContent = status;
        if (isError) {
          el.classList.add('save-status--error');
          el.classList.remove('save-status--success');
        } else if (status.includes('Saved')) {
          el.classList.add('save-status--success');
          el.classList.remove('save-status--error');
        } else {
          el.classList.remove('save-status--error');
          el.classList.remove('save-status--success');
        }
      }

      function showPublishResult(message, isSuccess, details) {
        var resultDiv = document.getElementById('publish-result');
        resultDiv.style.display = 'block';
        while (resultDiv.firstChild) {
          resultDiv.removeChild(resultDiv.firstChild);
        }
        var msgP = document.createElement('p');
        msgP.className = isSuccess ? 'success' : 'error';
        msgP.textContent = message;
        resultDiv.appendChild(msgP);
        if (details && isSuccess) {
          var detailsP = document.createElement('p');
          detailsP.className = 'success-details';
          detailsP.textContent = 'Saved as: ';
          var codeEl = document.createElement('code');
          codeEl.textContent = details;
          detailsP.appendChild(codeEl);
          resultDiv.appendChild(detailsP);
        }
      }

      function saveDraft() {
        if (!editor) return;
        var content = editor.value();
        var title = document.getElementById('session-title').value;
        localStorage.setItem(STORAGE_KEY, content);
        localStorage.setItem(TITLE_KEY, title);
        updateSaveStatus('Draft saved', false);
        setTimeout(function() { updateSaveStatus('Ready', false); }, 2000);
      }

      function loadDraft() {
        var savedContent = localStorage.getItem(STORAGE_KEY);
        var savedTitle = localStorage.getItem(TITLE_KEY);
        if (savedContent && editor) {
          editor.value(savedContent);
        }
        if (savedTitle) {
          document.getElementById('session-title').value = savedTitle;
        }
      }

      function debouncedSave() {
        updateSaveStatus('Saving...', false);
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveDraft, 500);
      }

      function publishNotes() {
        var token = getToken();
        if (!token || !editor) return;

        var publishBtn = document.getElementById('publish-btn');
        var resultDiv = document.getElementById('publish-result');
        var title = document.getElementById('session-title').value;
        var content = editor.value();

        if (!content.trim()) {
          showPublishResult('Please write some notes before saving.', false);
          return;
        }

        publishBtn.disabled = true;
        publishBtn.textContent = 'Saving...';
        resultDiv.style.display = 'none';

        var timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        var filename = title
          ? title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '') + '-' + timestamp + '.md'
          : 'session-' + timestamp + '.md';

        var apiUrl = getApiUrl();
        if (!apiUrl) {
          showPublishResult('API URL not configured. Deploy the DmNotesStack first.', false);
          publishBtn.disabled = false;
          publishBtn.textContent = 'Save';
          return;
        }

        fetch(apiUrl + '/upload-url?filename=' + encodeURIComponent(filename), {
          method: 'GET',
          headers: { 'X-DM-Token': token }
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(function(err) {
              throw new Error(err.error || 'Failed to get upload URL');
            });
          }
          return response.json();
        })
        .then(function(data) {
          var fullContent = '---\ntitle: "' + (title || 'Session Notes') + '"\ndate: "' + new Date().toISOString() + '"\ndraft: true\n---\n\n' + content;
          return fetch(data.uploadUrl, {
            method: 'PUT',
            headers: { 'Content-Type': 'text/markdown' },
            body: fullContent
          }).then(function(uploadResponse) {
            if (!uploadResponse.ok) {
              throw new Error('Failed to upload to S3');
            }
            return data.key;
          });
        })
        .then(function(key) {
          showPublishResult('Notes saved!', true, key);
          localStorage.removeItem(STORAGE_KEY);
          localStorage.removeItem(TITLE_KEY);
        })
        .catch(function(error) {
          console.error('Save error:', error);
          showPublishResult('Error: ' + error.message, false);
        })
        .finally(function() {
          publishBtn.disabled = false;
          publishBtn.textContent = 'Save';
        });
      }

      function init() {
        var token = getToken();
        console.log('DM Notes init, token:', token ? 'present' : 'missing');

        if (!token) {
          showAccessDenied();
          return;
        }

        showEditor();

        var textarea = document.getElementById('markdown-editor');
        console.log('EasyMDE available:', typeof EasyMDE !== 'undefined');
        console.log('Textarea found:', !!textarea);

        if (typeof EasyMDE !== 'undefined' && textarea) {
          // Initialize Turndown for HTML-to-Markdown conversion (Google Docs, Word paste)
          if (typeof TurndownService !== 'undefined') {
            turndownService = new TurndownService({
              headingStyle: 'atx',
              bulletListMarker: '-',
              codeBlockStyle: 'fenced'
            });
            // Keep line breaks from Google Docs
            turndownService.addRule('lineBreaks', {
              filter: 'br',
              replacement: function() { return '\n'; }
            });
          }

          editor = new EasyMDE({
            element: textarea,
            autofocus: true,
            spellChecker: false,
            minHeight: '500px',
            placeholder: 'Write your session notes here...\n\n## Session Summary\n\n## Key Events\n\n## NPCs Encountered\n\n## Loot & Rewards\n\n## Notes for Next Session',
            toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide'],
            status: ['lines', 'words', 'cursor']
          });
          loadDraft();
          editor.codemirror.on('change', debouncedSave);

          // Handle paste from rich text editors (Google Docs, Word)
          editor.codemirror.on('paste', function(cm, e) {
            if (!turndownService) return;

            var clipboardData = e.clipboardData || window.clipboardData;
            if (!clipboardData) return;

            var html = clipboardData.getData('text/html');
            if (html && html.trim()) {
              // Check if it's from a rich text source (has actual HTML tags beyond wrapper)
              var hasRichContent = /<(p|div|span|h[1-6]|ul|ol|li|table|strong|em|b|i)[^>]*>/i.test(html);
              if (hasRichContent) {
                e.preventDefault();
                var markdown = turndownService.turndown(html);
                // Clean up excessive whitespace from conversion
                markdown = markdown.replace(/\n{3,}/g, '\n\n').trim();
                var doc = cm.getDoc();
                doc.replaceSelection(markdown);
                debouncedSave();
              }
            }
          });

          console.log('EasyMDE initialized with rich text paste support');
        } else {
          console.error('EasyMDE not loaded or textarea not found');
        }

        var titleInput = document.getElementById('session-title');
        if (titleInput) {
          titleInput.addEventListener('input', debouncedSave);
        }

        var publishBtn = document.getElementById('publish-btn');
        if (publishBtn) {
          publishBtn.addEventListener('click', publishNotes);
        }

        var reviewBtn = document.getElementById('review-btn');
        if (reviewBtn) {
          reviewBtn.addEventListener('click', reviewNotes);
        }
      }

      function reviewNotes() {
        var token = getToken();
        if (!token || !editor) return;

        var reviewBtn = document.getElementById('review-btn');
        var reviewResult = document.getElementById('review-result');
        var content = editor.value();

        if (!content.trim()) {
          showReviewResult({ score: 0, suggestions: ['Please write some notes before reviewing.'], canPublish: false, summary: 'No content to review.' });
          return;
        }

        reviewBtn.disabled = true;
        reviewBtn.textContent = 'Reviewing...';
        reviewResult.style.display = 'none';

        var apiUrl = getApiUrl();
        if (!apiUrl) {
          showReviewResult({ score: 0, suggestions: ['API URL not configured.'], canPublish: false, summary: 'Configuration error.' });
          reviewBtn.disabled = false;
          reviewBtn.textContent = 'AI Review';
          return;
        }

        fetch(apiUrl + '/review', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-DM-Token': token
          },
          body: JSON.stringify({ content: content })
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(function(err) {
              if (err.disabled) {
                throw new Error('AI Review is temporarily disabled. You can still save your notes.');
              }
              throw new Error(err.error || 'Review failed');
            });
          }
          return response.json();
        })
        .then(function(data) {
          showReviewResult(data);
        })
        .catch(function(error) {
          console.error('Review error:', error);
          showReviewResult({ score: 0, suggestions: [error.message], canPublish: false, summary: 'Review failed.' });
        })
        .finally(function() {
          reviewBtn.disabled = false;
          reviewBtn.textContent = 'AI Review';
        });
      }

      function showReviewResult(data) {
        var reviewResult = document.getElementById('review-result');
        var scoreEl = document.getElementById('review-score');
        var statusEl = document.getElementById('review-status');
        var summaryEl = document.getElementById('review-summary');
        var suggestionsEl = document.getElementById('review-suggestions');

        reviewResult.style.display = 'block';
        scoreEl.textContent = data.score || '--';

        if (data.canPublish) {
          statusEl.textContent = 'Ready to save';
          statusEl.className = 'review-result__status review-result__status--success';
        } else {
          statusEl.textContent = 'Needs revision';
          statusEl.className = 'review-result__status review-result__status--warning';
        }

        summaryEl.textContent = data.summary || '';

        // Clear existing suggestions using DOM methods
        while (suggestionsEl.firstChild) {
          suggestionsEl.removeChild(suggestionsEl.firstChild);
        }
        if (data.suggestions && data.suggestions.length > 0) {
          data.suggestions.forEach(function(suggestion) {
            var li = document.createElement('li');
            li.textContent = suggestion;
            suggestionsEl.appendChild(li);
          });
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>

  <!-- Browser Tab JavaScript -->
  <script is:inline>
    (function() {
      var allNotes = [];
      var currentNoteKey = null;
      var NOTES_CACHE_KEY = 'dm-notes-cache';

      function getToken() {
        var params = new URLSearchParams(window.location.search);
        return params.get('token');
      }

      function getApiUrl() {
        var configEl = document.getElementById('config');
        return configEl ? configEl.dataset.apiUrl : '';
      }

      // PWA: Check online status
      function isOnline() {
        return navigator.onLine;
      }

      // PWA: Cache notes for offline viewing
      function cacheNotes(notes) {
        try {
          localStorage.setItem(NOTES_CACHE_KEY, JSON.stringify({
            notes: notes,
            timestamp: Date.now()
          }));
        } catch (e) {
          console.warn('Failed to cache notes:', e);
        }
      }

      // PWA: Load cached notes
      function getCachedNotes() {
        try {
          var cached = localStorage.getItem(NOTES_CACHE_KEY);
          if (cached) {
            var data = JSON.parse(cached);
            // Cache valid for 1 hour
            if (Date.now() - data.timestamp < 60 * 60 * 1000) {
              return data.notes;
            }
          }
        } catch (e) {
          console.warn('Failed to load cached notes:', e);
        }
        return null;
      }

      // Tab switching
      function initTabs() {
        var tabBtns = document.querySelectorAll('.tab-btn');
        tabBtns.forEach(function(btn) {
          btn.addEventListener('click', function() {
            var targetTab = this.dataset.tab;
            switchTab(targetTab);
          });
        });
      }

      function switchTab(tabName) {
        var tabBtns = document.querySelectorAll('.tab-btn');
        tabBtns.forEach(function(btn) {
          var isActive = btn.dataset.tab === tabName;
          if (isActive) {
            btn.classList.add('tab-btn--active');
            btn.setAttribute('aria-selected', 'true');
          } else {
            btn.classList.remove('tab-btn--active');
            btn.setAttribute('aria-selected', 'false');
          }
        });

        var editorContainer = document.getElementById('editor-container');
        var browserContainer = document.getElementById('browser-container');

        if (tabName === 'editor') {
          editorContainer.style.display = 'block';
          browserContainer.style.display = 'none';
        } else if (tabName === 'browser') {
          editorContainer.style.display = 'none';
          browserContainer.style.display = 'block';
          loadNotes();
        }
      }

      // Notes loading with offline support
      function loadNotes() {
        var token = getToken();
        var apiUrl = getApiUrl();
        if (!token || !apiUrl) return;

        showLoading(true);
        hideError();
        hideEmpty();

        // PWA: Check if offline
        if (!isOnline()) {
          var cached = getCachedNotes();
          if (cached) {
            allNotes = cached;
            renderNotes();
            showLoading(false);
            showOfflineIndicator(true);
            return;
          } else {
            showLoading(false);
            showError('You are offline and no cached notes are available.');
            return;
          }
        }

        showOfflineIndicator(false);

        fetch(apiUrl + '/notes', {
          method: 'GET',
          headers: { 'X-DM-Token': token }
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(function(err) {
              throw new Error(err.error || 'Failed to load notes');
            });
          }
          return response.json();
        })
        .then(function(data) {
          allNotes = data.notes || [];
          cacheNotes(allNotes); // PWA: Cache for offline
          renderNotes();
        })
        .catch(function(error) {
          console.error('Load notes error:', error);
          // PWA: Try cached notes on network error
          var cached = getCachedNotes();
          if (cached) {
            allNotes = cached;
            renderNotes();
            showOfflineIndicator(true);
          } else {
            showError(error.message);
          }
        })
        .finally(function() {
          showLoading(false);
        });
      }

      function showOfflineIndicator(show) {
        var indicator = document.getElementById('offline-indicator');
        if (indicator) {
          indicator.style.display = show ? 'block' : 'none';
        }
      }

      function showLoading(show) {
        document.getElementById('notes-loading').style.display = show ? 'flex' : 'none';
      }

      function showError(message) {
        var errorEl = document.getElementById('notes-error');
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }

      function hideError() {
        document.getElementById('notes-error').style.display = 'none';
      }

      function showEmpty(show) {
        document.getElementById('notes-empty').style.display = show ? 'block' : 'none';
      }

      function hideEmpty() {
        document.getElementById('notes-empty').style.display = 'none';
      }

      function renderNotes() {
        var grid = document.getElementById('notes-grid');
        var searchQuery = document.getElementById('notes-search').value.toLowerCase();
        var sortValue = document.getElementById('notes-sort').value;

        // Filter notes
        var filtered = allNotes.filter(function(note) {
          if (!searchQuery) return true;
          var title = (note.title || '').toLowerCase();
          return title.indexOf(searchQuery) !== -1;
        });

        // Sort notes
        filtered.sort(function(a, b) {
          switch (sortValue) {
            case 'date-desc':
              return new Date(b.date || 0) - new Date(a.date || 0);
            case 'date-asc':
              return new Date(a.date || 0) - new Date(b.date || 0);
            case 'title-asc':
              return (a.title || '').localeCompare(b.title || '');
            case 'title-desc':
              return (b.title || '').localeCompare(a.title || '');
            default:
              return 0;
          }
        });

        // Clear grid using safe DOM methods
        while (grid.firstChild) {
          grid.removeChild(grid.firstChild);
        }

        if (filtered.length === 0) {
          showEmpty(true);
          return;
        }

        showEmpty(false);

        // Build cards using safe DOM methods (no innerHTML)
        filtered.forEach(function(note) {
          var card = document.createElement('div');
          card.className = 'note-card';
          if (note.draft) {
            card.classList.add('note-card--draft');
          }

          // Title
          var titleEl = document.createElement('h3');
          titleEl.className = 'note-card__title';
          titleEl.textContent = note.title || 'Untitled';
          card.appendChild(titleEl);

          // Meta row
          var metaEl = document.createElement('div');
          metaEl.className = 'note-card__meta';

          var dateEl = document.createElement('span');
          dateEl.className = 'note-card__date';
          dateEl.textContent = formatDate(note.date);
          metaEl.appendChild(dateEl);

          if (note.draft) {
            var draftEl = document.createElement('span');
            draftEl.className = 'note-card__badge note-card__badge--draft';
            draftEl.textContent = 'Draft';
            metaEl.appendChild(draftEl);
          }

          card.appendChild(metaEl);

          // Size info
          var sizeEl = document.createElement('div');
          sizeEl.className = 'note-card__size';
          sizeEl.textContent = formatSize(note.size);
          card.appendChild(sizeEl);

          // Actions
          var actionsEl = document.createElement('div');
          actionsEl.className = 'note-card__actions';

          var viewBtn = document.createElement('button');
          viewBtn.className = 'btn btn--small btn--secondary';
          viewBtn.textContent = 'View';
          viewBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            viewNote(note.key);
          });
          actionsEl.appendChild(viewBtn);

          var deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn--small btn--danger-outline';
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            confirmDelete(note.key, note.title);
          });
          actionsEl.appendChild(deleteBtn);

          card.appendChild(actionsEl);

          // Click card to view
          card.addEventListener('click', function() {
            viewNote(note.key);
          });

          grid.appendChild(card);
        });
      }

      function formatDate(dateStr) {
        if (!dateStr) return 'Unknown date';
        try {
          var date = new Date(dateStr);
          return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
        } catch (e) {
          return dateStr;
        }
      }

      function formatSize(bytes) {
        if (!bytes) return '';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }

      // View note modal
      function viewNote(key) {
        var token = getToken();
        var apiUrl = getApiUrl();
        if (!token || !apiUrl) return;

        currentNoteKey = key;
        var modal = document.getElementById('view-modal');
        var titleEl = document.getElementById('view-modal-title');
        var dateEl = document.getElementById('view-modal-date');
        var statusEl = document.getElementById('view-modal-status');
        var bodyEl = document.getElementById('view-modal-body');

        // Show modal with loading state
        modal.style.display = 'flex';
        titleEl.textContent = 'Loading...';
        dateEl.textContent = '';
        statusEl.textContent = '';
        bodyEl.textContent = 'Loading note content...';

        fetch(apiUrl + '/notes/' + encodeURIComponent(key), {
          method: 'GET',
          headers: { 'X-DM-Token': token }
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(function(err) {
              throw new Error(err.error || 'Failed to load note');
            });
          }
          return response.json();
        })
        .then(function(data) {
          titleEl.textContent = data.title || 'Untitled';
          dateEl.textContent = formatDate(data.date);

          // Clear and set status
          while (statusEl.firstChild) {
            statusEl.removeChild(statusEl.firstChild);
          }
          if (data.draft) {
            var draftBadge = document.createElement('span');
            draftBadge.className = 'badge badge--draft';
            draftBadge.textContent = 'Draft';
            statusEl.appendChild(draftBadge);
          }

          // Render markdown content safely with DOMPurify
          var content = data.content || '';
          if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
            // Configure marked for syntax highlighting
            if (typeof hljs !== 'undefined') {
              marked.setOptions({
                highlight: function(code, lang) {
                  if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                  }
                  return hljs.highlightAuto(code).value;
                }
              });
            }
            // Parse markdown then sanitize HTML
            var rawHtml = marked.parse(content);
            var cleanHtml = DOMPurify.sanitize(rawHtml);
            bodyEl.innerHTML = cleanHtml;
          } else {
            // Fallback: display as plain text
            bodyEl.textContent = content;
          }
        })
        .catch(function(error) {
          console.error('View note error:', error);
          titleEl.textContent = 'Error';
          bodyEl.textContent = 'Failed to load note: ' + error.message;
        });
      }

      // Download note
      function downloadNote() {
        if (!currentNoteKey) return;

        var token = getToken();
        var apiUrl = getApiUrl();
        if (!token || !apiUrl) return;

        fetch(apiUrl + '/notes/' + encodeURIComponent(currentNoteKey), {
          method: 'GET',
          headers: { 'X-DM-Token': token }
        })
        .then(function(response) {
          if (!response.ok) throw new Error('Failed to download');
          return response.json();
        })
        .then(function(data) {
          var blob = new Blob([data.rawContent || data.content || ''], { type: 'text/markdown' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = (data.title || 'note').replace(/[^a-z0-9]+/gi, '-') + '.md';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        })
        .catch(function(error) {
          console.error('Download error:', error);
          alert('Failed to download note: ' + error.message);
        });
      }

      // Delete confirmation
      function confirmDelete(key, title) {
        currentNoteKey = key;
        var modal = document.getElementById('delete-modal');
        var titleEl = document.getElementById('delete-modal-title');
        titleEl.textContent = title || 'Untitled';
        modal.style.display = 'flex';
      }

      function deleteNote() {
        if (!currentNoteKey) return;

        var token = getToken();
        var apiUrl = getApiUrl();
        if (!token || !apiUrl) return;

        var deleteBtn = document.getElementById('confirm-delete-btn');
        deleteBtn.disabled = true;
        deleteBtn.textContent = 'Deleting...';

        fetch(apiUrl + '/notes/' + encodeURIComponent(currentNoteKey), {
          method: 'DELETE',
          headers: { 'X-DM-Token': token }
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(function(err) {
              throw new Error(err.error || 'Failed to delete note');
            });
          }
          return response.json();
        })
        .then(function() {
          closeAllModals();
          loadNotes(); // Refresh the list
        })
        .catch(function(error) {
          console.error('Delete error:', error);
          alert('Failed to delete note: ' + error.message);
        })
        .finally(function() {
          deleteBtn.disabled = false;
          deleteBtn.textContent = 'Delete';
        });
      }

      // Modal helpers
      function closeAllModals() {
        document.querySelectorAll('.modal').forEach(function(modal) {
          modal.style.display = 'none';
        });
        currentNoteKey = null;
      }

      function initModals() {
        // Close buttons
        document.querySelectorAll('[data-close-modal]').forEach(function(btn) {
          btn.addEventListener('click', closeAllModals);
        });

        // Backdrop clicks
        document.querySelectorAll('.modal__backdrop').forEach(function(backdrop) {
          backdrop.addEventListener('click', closeAllModals);
        });

        // Escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            closeAllModals();
          }
        });

        // Download button
        var downloadBtn = document.getElementById('download-note-btn');
        if (downloadBtn) {
          downloadBtn.addEventListener('click', downloadNote);
        }

        // Delete buttons
        var deleteNoteBtn = document.getElementById('delete-note-btn');
        if (deleteNoteBtn) {
          deleteNoteBtn.addEventListener('click', function() {
            // Close view modal and open delete confirmation
            document.getElementById('view-modal').style.display = 'none';
            var note = allNotes.find(function(n) { return n.key === currentNoteKey; });
            confirmDelete(currentNoteKey, note ? note.title : '');
          });
        }

        var confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        if (confirmDeleteBtn) {
          confirmDeleteBtn.addEventListener('click', deleteNote);
        }
      }

      // Search and sort
      function initFilters() {
        var searchInput = document.getElementById('notes-search');
        var sortSelect = document.getElementById('notes-sort');

        if (searchInput) {
          searchInput.addEventListener('input', renderNotes);
        }

        if (sortSelect) {
          sortSelect.addEventListener('change', renderNotes);
        }
      }

      // Initialize browser
      function initBrowser() {
        var token = getToken();
        if (!token) return;

        // Show tab navigation
        var tabNav = document.getElementById('tab-navigation');
        if (tabNav) {
          tabNav.style.display = 'flex';
        }

        initTabs();
        initModals();
        initFilters();

        // PWA: Listen for online/offline events
        window.addEventListener('online', function() {
          showOfflineIndicator(false);
          // Refresh notes when back online
          var browserContainer = document.getElementById('browser-container');
          if (browserContainer && browserContainer.style.display !== 'none') {
            loadNotes();
          }
        });

        window.addEventListener('offline', function() {
          showOfflineIndicator(true);
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBrowser);
      } else {
        initBrowser();
      }
    })();
  </script>

  <style>
    /* Accessibility utility */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .dm-notes {
      min-height: 80vh;
    }

    .access-denied {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      text-align: center;
    }

    .access-denied__content h1 {
      color: var(--color-accent);
      font-family: var(--font-display);
      margin-bottom: var(--space-md);
    }

    .access-denied__hint {
      margin-top: var(--space-lg);
      color: var(--color-text-muted);
      font-size: var(--text-sm);
    }

    .access-denied__hint code {
      background: var(--color-bg-secondary);
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
    }

    .editor-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: var(--space-lg);
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
      flex-wrap: wrap;
      gap: var(--space-md);
    }

    .editor-header h1 {
      font-family: var(--font-display);
      color: var(--color-gold);
      margin: 0;
    }

    .editor-header__actions {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .save-status {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
      background: var(--color-bg-secondary);
    }

    .save-status--success {
      color: var(--color-success, #22c55e);
    }

    .save-status--error {
      color: var(--color-error, #ef4444);
    }

    .btn {
      padding: var(--space-sm) var(--space-lg);
      border: 2px solid var(--color-gold);
      border-radius: var(--radius-md);
      font-family: var(--font-display);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn--secondary {
      background: transparent;
      color: var(--color-gold);
    }

    .btn--secondary:hover:not(:disabled) {
      background: var(--color-gold);
      color: var(--color-bg);
    }

    .btn--primary {
      background: var(--color-gold);
      color: var(--color-bg);
    }

    .btn--primary:hover:not(:disabled) {
      background: var(--color-gold-light);
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .editor-meta {
      margin-bottom: var(--space-lg);
    }

    .editor-meta label {
      display: block;
      font-weight: 600;
      color: var(--color-text);
    }

    .editor-meta input {
      width: 100%;
      margin-top: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-bg-secondary);
      color: var(--color-text);
      font-size: var(--text-base);
      font-family: var(--font-sans);
    }

    .editor-meta input:focus {
      outline: none;
      border-color: var(--color-gold);
    }

    .editor-wrapper {
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    /* EasyMDE editor sizing for long documents */
    .editor-wrapper :global(.EasyMDEContainer) {
      display: flex;
      flex-direction: column;
    }

    .editor-wrapper :global(.CodeMirror) {
      height: 60vh !important;
      border: 2px solid var(--color-border);
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      background: var(--color-bg-secondary);
      font-family: var(--font-mono);
      font-size: var(--text-base);
      line-height: 1.6;
    }

    .editor-wrapper :global(.CodeMirror-scroll) {
      min-height: 100%;
      overflow-y: scroll !important;
      overflow-x: auto !important;
    }

    .editor-wrapper :global(.CodeMirror-sizer) {
      min-height: 100% !important;
    }

    /* Dark theme adjustments for EasyMDE */
    .editor-wrapper :global(.editor-toolbar) {
      background: var(--color-bg-secondary);
      border: 2px solid var(--color-border);
      border-bottom: none;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
    }

    .editor-wrapper :global(.editor-toolbar button) {
      color: var(--color-text) !important;
    }

    .editor-wrapper :global(.editor-toolbar button:hover),
    .editor-wrapper :global(.editor-toolbar button.active) {
      background: var(--color-gold) !important;
      color: var(--color-bg) !important;
    }

    .editor-wrapper :global(.editor-statusbar) {
      background: var(--color-bg-secondary);
      border: 2px solid var(--color-border);
      border-top: none;
      color: var(--color-text-muted);
      padding: var(--space-xs) var(--space-sm);
    }

    /* CodeMirror dark mode text colors */
    .editor-wrapper :global(.CodeMirror),
    .editor-wrapper :global(.CodeMirror-code),
    .editor-wrapper :global(.CodeMirror-line) {
      color: #e8e6e3 !important;
    }

    .editor-wrapper :global(.CodeMirror pre.CodeMirror-placeholder) {
      color: #8b8685 !important;
    }

    .editor-wrapper :global(.CodeMirror-cursor) {
      border-left-color: var(--color-gold) !important;
    }

    .editor-wrapper :global(.CodeMirror-selected) {
      background: rgba(200, 168, 108, 0.3) !important;
    }

    .editor-wrapper :global(.CodeMirror-focused .CodeMirror-selected) {
      background: rgba(200, 168, 108, 0.4) !important;
    }

    /* Markdown syntax highlighting in dark mode */
    .editor-wrapper :global(.cm-header) {
      color: var(--color-gold) !important;
    }

    .editor-wrapper :global(.cm-header-1) {
      font-size: 1.5em;
    }

    .editor-wrapper :global(.cm-header-2) {
      font-size: 1.3em;
    }

    .editor-wrapper :global(.cm-header-3) {
      font-size: 1.1em;
    }

    .editor-wrapper :global(.cm-strong) {
      color: #f5f3f0 !important;
      font-weight: bold;
    }

    .editor-wrapper :global(.cm-em) {
      color: #d4d0cb !important;
      font-style: italic;
    }

    .editor-wrapper :global(.cm-link) {
      color: #7eb8da !important;
    }

    .editor-wrapper :global(.cm-url) {
      color: #8b8685 !important;
    }

    .editor-wrapper :global(.cm-quote) {
      color: #b8a88a !important;
      font-style: italic;
    }

    .editor-wrapper :global(.cm-comment) {
      color: #8b8685 !important;
    }

    .editor-wrapper :global(.cm-formatting) {
      color: #6b6563 !important;
    }

    /* Fullscreen mode adjustments */
    .editor-wrapper :global(.CodeMirror-fullscreen) {
      max-height: 100vh !important;
    }

    .editor-wrapper :global(.editor-toolbar.fullscreen) {
      z-index: 1001;
    }

    .review-result {
      margin-top: var(--space-lg);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      background: var(--color-bg-secondary);
      border: 2px solid var(--color-border);
    }

    .review-result__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
    }

    .review-result__score {
      font-size: var(--text-lg);
      color: var(--color-text);
    }

    .review-result__score strong {
      color: var(--color-gold);
      font-family: var(--font-display);
    }

    .review-result__status {
      font-size: var(--text-sm);
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
    }

    .review-result__status--success {
      background: rgba(34, 197, 94, 0.2);
      color: var(--color-success, #22c55e);
    }

    .review-result__status--warning {
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
    }

    .review-result__summary {
      margin-bottom: var(--space-md);
      color: var(--color-text);
      font-style: italic;
    }

    .review-result__suggestions {
      margin: 0;
      padding-left: var(--space-lg);
      color: var(--color-text-muted);
    }

    .review-result__suggestions li {
      margin-bottom: var(--space-xs);
    }

    .publish-result {
      margin-top: var(--space-lg);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      background: var(--color-bg-secondary);
    }

    .publish-result .success {
      color: var(--color-success, #22c55e);
      margin: 0;
    }

    .publish-result .success-details {
      margin-top: var(--space-sm);
      font-size: var(--text-sm);
      color: var(--color-text-muted);
    }

    .publish-result .success-details code {
      background: var(--color-bg);
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
    }

    .publish-result .error {
      color: var(--color-error, #ef4444);
      margin: 0;
    }

    /* ============================================
       Tab Navigation
       ============================================ */
    .tab-navigation {
      display: flex;
      gap: var(--space-sm);
      max-width: 1000px;
      margin: 0 auto var(--space-lg);
      padding: 0 var(--space-lg);
    }

    .tab-btn {
      padding: var(--space-sm) var(--space-lg);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      background: var(--color-bg-secondary);
      color: var(--color-text-muted);
      font-family: var(--font-display);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      border-bottom: none;
      position: relative;
      top: 2px;
    }

    .tab-btn:hover {
      color: var(--color-text);
      background: var(--color-bg);
    }

    .tab-btn--active {
      background: var(--color-bg);
      color: var(--color-gold);
      border-color: var(--color-gold);
    }

    /* ============================================
       Browser Container
       ============================================ */
    .browser-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: var(--space-lg);
    }

    .browser-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
      flex-wrap: wrap;
      gap: var(--space-md);
    }

    .browser-header h1 {
      font-family: var(--font-display);
      color: var(--color-gold);
      margin: 0;
    }

    .browser-header__controls {
      display: flex;
      gap: var(--space-md);
      flex-wrap: wrap;
    }

    .notes-search {
      padding: var(--space-sm) var(--space-md);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-bg-secondary);
      color: var(--color-text);
      font-size: var(--text-sm);
      min-width: 200px;
    }

    .notes-search:focus {
      outline: none;
      border-color: var(--color-gold);
    }

    .notes-sort {
      padding: var(--space-sm) var(--space-md);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-bg-secondary);
      color: var(--color-text);
      font-size: var(--text-sm);
      cursor: pointer;
    }

    .notes-sort:focus {
      outline: none;
      border-color: var(--color-gold);
    }

    /* Offline indicator */
    .offline-indicator {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      background: rgba(234, 179, 8, 0.15);
      border: 1px solid var(--color-warning, #eab308);
      border-radius: var(--radius-md);
      color: var(--color-warning, #eab308);
      font-size: var(--text-sm);
      margin-bottom: var(--space-md);
    }

    .offline-icon {
      font-size: var(--text-lg);
    }

    /* Loading state */
    .notes-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-md);
      padding: var(--space-xl);
      color: var(--color-text-muted);
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error state */
    .notes-error {
      padding: var(--space-lg);
      background: rgba(239, 68, 68, 0.1);
      border: 2px solid var(--color-error, #ef4444);
      border-radius: var(--radius-md);
      color: var(--color-error, #ef4444);
      text-align: center;
    }

    /* Empty state */
    .notes-empty {
      text-align: center;
      padding: var(--space-xl);
      color: var(--color-text-muted);
    }

    .notes-empty__hint {
      font-size: var(--text-sm);
      margin-top: var(--space-md);
    }

    /* ============================================
       Notes Grid (uses :global for JS-created elements)
       ============================================ */
    .notes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--space-lg);
    }

    :global(.note-card) {
      background: var(--color-bg-secondary);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    :global(.note-card:hover) {
      border-color: var(--color-gold);
      transform: translateY(-2px);
    }

    :global(.note-card--draft) {
      border-left: 4px solid var(--color-warning, #eab308);
    }

    :global(.note-card__title) {
      font-family: var(--font-display);
      font-size: var(--text-lg);
      color: var(--color-gold);
      margin: 0 0 var(--space-sm);
      line-height: 1.3;
    }

    :global(.note-card__meta) {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-sm);
    }

    :global(.note-card__date) {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
    }

    :global(.note-card__badge) {
      font-size: var(--text-xs);
      padding: 2px var(--space-xs);
      border-radius: var(--radius-sm);
      font-weight: 600;
      text-transform: uppercase;
    }

    :global(.note-card__badge--draft) {
      background: rgba(234, 179, 8, 0.2);
      color: var(--color-warning, #eab308);
    }

    :global(.note-card__size) {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-bottom: var(--space-md);
    }

    :global(.note-card__actions) {
      display: flex;
      gap: var(--space-sm);
    }

    /* ============================================
       Button Variants
       ============================================ */
    .btn--small {
      padding: var(--space-xs) var(--space-sm);
      font-size: var(--text-sm);
    }

    .btn--danger {
      background: var(--color-error, #ef4444);
      border-color: var(--color-error, #ef4444);
      color: white;
    }

    .btn--danger:hover:not(:disabled) {
      background: #dc2626;
      border-color: #dc2626;
    }

    .btn--danger-outline {
      background: transparent;
      border-color: var(--color-error, #ef4444);
      color: var(--color-error, #ef4444);
    }

    .btn--danger-outline:hover:not(:disabled) {
      background: var(--color-error, #ef4444);
      color: white;
    }

    /* ============================================
       Modal Styles
       ============================================ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal__backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
    }

    .modal__content {
      position: relative;
      background: var(--color-bg);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .modal__content--large {
      max-width: 800px;
    }

    .modal__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--color-border);
    }

    .modal__header h2 {
      font-family: var(--font-display);
      color: var(--color-gold);
      margin: 0;
      font-size: var(--text-xl);
    }

    .modal__close {
      background: none;
      border: none;
      font-size: var(--text-2xl);
      color: var(--color-text-muted);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal__close:hover {
      color: var(--color-text);
    }

    .modal__meta {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-sm) var(--space-lg);
      color: var(--color-text-muted);
      font-size: var(--text-sm);
      border-bottom: 1px solid var(--color-border);
    }

    .modal__body {
      flex: 1;
      padding: var(--space-lg);
      overflow-y: auto;
      color: var(--color-text);
    }

    .modal__footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-lg);
      border-top: 1px solid var(--color-border);
    }

    /* Delete modal specifics */
    .delete-modal__title {
      font-weight: 600;
      color: var(--color-gold);
      font-family: var(--font-display);
    }

    .delete-modal__warning {
      color: var(--color-error, #ef4444);
      font-size: var(--text-sm);
    }

    /* Badge styles */
    .badge {
      font-size: var(--text-xs);
      padding: 2px var(--space-xs);
      border-radius: var(--radius-sm);
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge--draft {
      background: rgba(234, 179, 8, 0.2);
      color: var(--color-warning, #eab308);
    }

    /* ============================================
       Markdown Content Styles
       ============================================ */
    .markdown-content {
      line-height: 1.7;
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4 {
      font-family: var(--font-display);
      color: var(--color-gold);
      margin-top: var(--space-lg);
      margin-bottom: var(--space-sm);
    }

    .markdown-content h1 { font-size: var(--text-2xl); }
    .markdown-content h2 { font-size: var(--text-xl); }
    .markdown-content h3 { font-size: var(--text-lg); }

    .markdown-content p {
      margin-bottom: var(--space-md);
    }

    .markdown-content ul,
    .markdown-content ol {
      margin-bottom: var(--space-md);
      padding-left: var(--space-lg);
    }

    .markdown-content li {
      margin-bottom: var(--space-xs);
    }

    .markdown-content pre {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      overflow-x: auto;
      margin-bottom: var(--space-md);
    }

    .markdown-content code {
      font-family: var(--font-mono);
      font-size: 0.9em;
    }

    .markdown-content :not(pre) > code {
      background: var(--color-bg-secondary);
      padding: 2px var(--space-xs);
      border-radius: var(--radius-sm);
    }

    .markdown-content blockquote {
      border-left: 4px solid var(--color-gold);
      margin: var(--space-md) 0;
      padding-left: var(--space-md);
      color: var(--color-text-muted);
      font-style: italic;
    }

    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: var(--space-md);
    }

    .markdown-content th,
    .markdown-content td {
      border: 1px solid var(--color-border);
      padding: var(--space-sm);
      text-align: left;
    }

    .markdown-content th {
      background: var(--color-bg-secondary);
      font-weight: 600;
    }

    .markdown-content hr {
      border: none;
      border-top: 1px solid var(--color-border);
      margin: var(--space-lg) 0;
    }
  </style>
</BaseLayout>
