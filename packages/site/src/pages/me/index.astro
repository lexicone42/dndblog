---
/**
 * Unified Dashboard - Personal landing page after login
 * Shows role-appropriate navigation based on Cognito auth
 */

import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all characters for mapping slugs to names
const allCharacters = await getCollection('characters');
const characterMap = Object.fromEntries(
  allCharacters.map((c: typeof allCharacters[0]) => [c.id, c.data])
);
---

<BaseLayout
  title="My Dashboard - Rudiger's Evocation of Events"
  description="Your personal dashboard for the campaign."
>
  <div class="dashboard">
    <!-- Loading state while checking auth -->
    <div id="loading-state" class="dashboard-state">
      <div class="loading-spinner"></div>
      <p>Checking authentication...</p>
    </div>

    <!-- Not authenticated state -->
    <div id="unauthenticated-state" class="dashboard-state" style="display: none;">
      <div class="auth-prompt">
        <h1>Welcome, Adventurer</h1>
        <p>Sign in to access your character tools and campaign resources.</p>
        <a href="/auth/login" class="btn btn-primary btn-large">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
          </svg>
          Sign In
        </a>
      </div>
    </div>

    <!-- Authenticated state -->
    <div id="authenticated-state" class="dashboard-state" style="display: none;">
      <header class="dashboard-header">
        <h1 class="dashboard-title">Welcome back, <span id="user-name">Adventurer</span></h1>
        <p class="dashboard-subtitle">What would you like to do?</p>
      </header>

      <div class="dashboard-grid">
        <!-- Player Section (shown if has character) -->
        <div id="player-section" class="dashboard-section" style="display: none;">
          <h2 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Your Character
          </h2>

          <a id="session-tracker-link" href="#" class="action-card action-card--primary">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
            </div>
            <div class="action-content">
              <h3 class="action-title">Session Tracker</h3>
              <p class="action-description">Track HP, spell slots, conditions, and more during play.</p>
              <span id="character-name-badge" class="character-badge"></span>
            </div>
            <div class="action-arrow">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </div>
          </a>
        </div>

        <!-- DM Section (shown if DM) -->
        <div id="dm-section" class="dashboard-section" style="display: none;">
          <h2 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
            Dungeon Master
          </h2>

          <div class="action-grid">
            <a href="/dm" class="action-card action-card--dm">
              <div class="action-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="3" y1="9" x2="21" y2="9"></line>
                  <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
              </div>
              <div class="action-content">
                <h3 class="action-title">DM Dashboard</h3>
                <p class="action-description">Session notes, AI review, and campaign management.</p>
              </div>
            </a>

            <a href="/dm/party-tracker" class="action-card action-card--dm">
              <div class="action-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </div>
              <div class="action-content">
                <h3 class="action-title">Party Tracker</h3>
                <p class="action-description">Live view of all player HP, conditions, and spell slots.</p>
                <span class="live-badge">Live Updates</span>
              </div>
            </a>

            <a href="/dm/entities" class="action-card action-card--dm">
              <div class="action-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"></path>
                </svg>
              </div>
              <div class="action-content">
                <h3 class="action-title">Entity Editor</h3>
                <p class="action-description">Create and edit characters, items, and locations.</p>
              </div>
            </a>
          </div>
        </div>

        <!-- Always visible: Party resources -->
        <div class="dashboard-section">
          <h2 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
            Party Resources
          </h2>

          <div class="action-grid">
            <a href="/party" class="action-card">
              <div class="action-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </div>
              <div class="action-content">
                <h3 class="action-title">Party Hub</h3>
                <p class="action-description">Guides, synergies, and party information.</p>
              </div>
            </a>

            <a href="/campaign" class="action-card">
              <div class="action-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="2" y1="12" x2="22" y2="12"></line>
                  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
              </div>
              <div class="action-content">
                <h3 class="action-title">Campaign</h3>
                <p class="action-description">Characters, locations, items, and lore.</p>
              </div>
            </a>
          </div>
        </div>
      </div>

      <!-- Account section -->
      <div class="account-section">
        <button id="sign-out-btn" class="btn btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Sign Out
        </button>
      </div>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ characterMap }}>
  const COGNITO_AUTH_KEY = 'dndblog-cognito-auth';

  // Character name lookup
  const characters = characterMap;

  function getCharacterName(slug) {
    return characters[slug]?.name || slug;
  }

  function checkAuth() {
    const loadingState = document.getElementById('loading-state');
    const unauthState = document.getElementById('unauthenticated-state');
    const authState = document.getElementById('authenticated-state');

    const cognitoAuth = localStorage.getItem(COGNITO_AUTH_KEY);

    if (!cognitoAuth) {
      loadingState.style.display = 'none';
      unauthState.style.display = 'flex';
      return;
    }

    try {
      const auth = JSON.parse(cognitoAuth);

      // Check if expired
      if (auth.expiresAt && auth.expiresAt < Date.now()) {
        localStorage.removeItem(COGNITO_AUTH_KEY);
        loadingState.style.display = 'none';
        unauthState.style.display = 'flex';
        return;
      }

      // User is authenticated
      loadingState.style.display = 'none';
      authState.style.display = 'block';

      // Set user name
      const userName = auth.email?.split('@')[0] || 'Adventurer';
      document.getElementById('user-name').textContent = userName;

      // Show DM section if DM
      if (auth.roles?.isDm) {
        document.getElementById('dm-section').style.display = 'block';
      }

      // Show player section if has character
      const characterSlug = auth.characterSlug;
      if (characterSlug) {
        document.getElementById('player-section').style.display = 'block';
        document.getElementById('session-tracker-link').href = `/campaign/session/${characterSlug}`;
        document.getElementById('character-name-badge').textContent = getCharacterName(characterSlug);
      }

    } catch (e) {
      console.error('Auth parse error:', e);
      loadingState.style.display = 'none';
      unauthState.style.display = 'flex';
    }
  }

  // Sign out handler
  document.getElementById('sign-out-btn')?.addEventListener('click', () => {
    localStorage.removeItem(COGNITO_AUTH_KEY);
    window.dispatchEvent(new Event('auth-change'));
    window.location.href = '/';
  });

  // Check auth on load
  checkAuth();

  // Listen for auth changes
  window.addEventListener('storage', checkAuth);
  window.addEventListener('auth-change', checkAuth);
</script>

<style>
  .dashboard {
    min-height: calc(100vh - var(--header-height) - 100px);
    padding: var(--space-xl) var(--space-lg);
    max-width: 900px;
    margin: 0 auto;
  }

  .dashboard-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  #loading-state {
    min-height: 300px;
    color: var(--color-text-muted);
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: var(--space-md);
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Auth prompt */
  .auth-prompt {
    text-align: center;
    padding: var(--space-2xl);
  }

  .auth-prompt h1 {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    color: var(--color-gold);
    margin: 0 0 var(--space-md);
  }

  .auth-prompt p {
    color: var(--color-text-secondary);
    margin: 0 0 var(--space-xl);
    font-size: var(--text-lg);
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-lg);
    border-radius: var(--radius-md);
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all var(--transition-fast);
    border: none;
    font-size: var(--text-base);
  }

  .btn-primary {
    background: var(--color-gold);
    color: var(--color-bg);
  }

  .btn-primary:hover {
    background: var(--color-gold-light, #d4b44a);
    transform: translateY(-2px);
  }

  .btn-large {
    padding: var(--space-md) var(--space-xl);
    font-size: var(--text-lg);
  }

  .btn-secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-bg-tertiary);
    color: var(--color-text);
  }

  /* Dashboard header */
  .dashboard-header {
    text-align: center;
    margin-bottom: var(--space-2xl);
  }

  .dashboard-title {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    color: var(--color-text);
    margin: 0 0 var(--space-xs);
  }

  .dashboard-title span {
    color: var(--color-gold);
  }

  .dashboard-subtitle {
    color: var(--color-text-secondary);
    margin: 0;
  }

  /* Dashboard grid */
  .dashboard-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .dashboard-section {
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    border: 1px solid var(--color-border);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-family: var(--font-display);
    font-size: var(--text-lg);
    color: var(--color-gold);
    margin: 0 0 var(--space-md);
  }

  /* Action cards */
  .action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-md);
  }

  .action-card {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    transition: all var(--transition-fast);
  }

  .action-card:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .action-card--primary {
    background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-bg-secondary) 100%);
    border: 2px solid var(--color-accent);
  }

  .action-card--primary:hover {
    border-color: var(--color-gold);
    box-shadow: 0 4px 20px rgba(var(--color-accent-rgb, 99, 102, 241), 0.2);
  }

  .action-card--dm {
    border-color: var(--color-gold);
    border-width: 1px;
  }

  .action-card--dm:hover {
    border-color: var(--color-gold);
    box-shadow: 0 4px 20px rgba(var(--color-gold-rgb, 201, 162, 39), 0.2);
  }

  .action-icon {
    flex-shrink: 0;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
    color: var(--color-text-muted);
  }

  .action-card--primary .action-icon {
    background: var(--color-accent);
    color: white;
  }

  .action-card--dm .action-icon {
    background: var(--color-gold);
    color: var(--color-bg);
  }

  .action-content {
    flex: 1;
    min-width: 0;
  }

  .action-title {
    font-family: var(--font-display);
    font-size: var(--text-base);
    margin: 0 0 var(--space-xs);
    color: var(--color-text);
  }

  .action-card:hover .action-title {
    color: var(--color-accent);
  }

  .action-card--dm:hover .action-title {
    color: var(--color-gold);
  }

  .action-description {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
    line-height: 1.4;
  }

  .action-arrow {
    flex-shrink: 0;
    color: var(--color-text-muted);
  }

  .character-badge {
    display: inline-block;
    margin-top: var(--space-xs);
    padding: 2px var(--space-sm);
    background: var(--color-accent);
    color: white;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
  }

  .live-badge {
    display: inline-block;
    margin-top: var(--space-xs);
    padding: 2px var(--space-sm);
    background: var(--color-success, #22c55e);
    color: white;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
  }

  /* Account section */
  .account-section {
    margin-top: var(--space-2xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: center;
  }

  @media (max-width: 640px) {
    .dashboard {
      padding: var(--space-md);
    }

    .action-grid {
      grid-template-columns: 1fr;
    }

    .action-card {
      flex-direction: column;
      text-align: center;
    }

    .action-arrow {
      display: none;
    }
  }
</style>
