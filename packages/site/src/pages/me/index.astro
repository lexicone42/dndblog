---
/**
 * Personal dashboard after login
 * Shows role-appropriate navigation based on Cognito auth
 */

import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all characters for mapping slugs to names
const allCharacters = await getCollection('characters');
const characterMap = Object.fromEntries(
  allCharacters.map((c: typeof allCharacters[0]) => [c.id, c.data])
);

// Next mission story teaser - update this before each session!
const nextMissionTeaser = {
  title: "The Circle Closes",
  summary: "The Slanted Circle has the regulator plans, and the Ley Maw grows with each passing hour. Somewhere in Sharn's shadows, agents prepare a ritual that could tear the city apart—or open a door to something far worse.",
  date: "Session 11 • Soon",
};
---

<BaseLayout
  title="The Tavern - Rudiger's Evocation of Events"
  description="Your cozy corner of the campaign."
>
  <div class="dashboard">
    <!-- Loading state while checking auth -->
    <div id="loading-state" class="dashboard-state">
      <div class="loading-spinner"></div>
      <p class="loading-text">Loading...</p>
    </div>

    <!-- Not authenticated state -->
    <div id="unauthenticated-state" class="dashboard-state" style="display: none;">
      <div class="auth-prompt">
        <h1>Welcome, Traveler</h1>
        <p>Sign in to access your campaign dashboard.</p>
        <button id="sign-in-btn" class="btn btn-primary btn-large">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
          </svg>
          Sign In
        </button>
      </div>
    </div>

    <!-- Authenticated state -->
    <div id="authenticated-state" class="dashboard-state" style="display: none;">
      <header class="dashboard-header">
        <div class="tavern-welcome">Welcome back</div>
        <h1 class="dashboard-title"><span id="user-name">Adventurer</span></h1>
      </header>

      <!-- Next Mission Teaser -->
      <div class="mission-teaser">
        <div class="mission-teaser__label">{nextMissionTeaser.date}</div>
        <h2 class="mission-teaser__title">{nextMissionTeaser.title}</h2>
        <p class="mission-teaser__summary">{nextMissionTeaser.summary}</p>
      </div>

      <div class="dashboard-grid">
        <!-- Player Section (shown if has character) -->
        <div id="player-section" class="dashboard-section" style="display: none;">
          <h2 class="section-title">Your Character</h2>

          <a id="session-tracker-link" href="#" class="action-card action-card--primary">
            <div class="action-content">
              <h3 class="action-title">Session Tracker</h3>
              <p class="action-description">Track HP, spell slots, and conditions during play.</p>
              <span id="character-name-badge" class="character-badge"></span>
            </div>
            <div class="action-arrow">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </div>
          </a>
        </div>

        <!-- DM Section (shown if DM) -->
        <div id="dm-section" class="dashboard-section dashboard-section--dm" style="display: none;">
          <h2 class="section-title">DM Tools</h2>

          <div class="action-grid">
            <a href="/dm" class="action-card action-card--dm">
              <div class="action-content">
                <h3 class="action-title">Session Notes</h3>
                <p class="action-description">Write, review, and publish session content.</p>
              </div>
            </a>

            <a href="/dm/party-tracker" class="action-card action-card--dm">
              <div class="action-content">
                <h3 class="action-title">Party Tracker</h3>
                <p class="action-description">View live party status during sessions.</p>
                <span class="live-badge">Live</span>
              </div>
            </a>

            <a href="/dm/entities" class="action-card action-card--dm">
              <div class="action-content">
                <h3 class="action-title">Entity Editor</h3>
                <p class="action-description">Create and edit NPCs, items, and locations.</p>
              </div>
            </a>
          </div>
        </div>

        <!-- Always visible: Party resources -->
        <div class="dashboard-section">
          <h2 class="section-title">Campaign Resources</h2>

          <div class="action-grid">
            <a href="/party" class="action-card">
              <div class="action-content">
                <h3 class="action-title">Party</h3>
                <p class="action-description">View party members and their abilities.</p>
              </div>
            </a>

            <a href="/reference" class="action-card">
              <div class="action-content">
                <h3 class="action-title">World Compendium</h3>
                <p class="action-description">Locations, factions, and lore from the campaign.</p>
              </div>
            </a>
          </div>
        </div>
      </div>

      <!-- Account section -->
      <div class="account-section">
        <button id="sign-out-btn" class="btn btn-secondary">Sign Out</button>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { getLoginUrl } from '@lib/auth';

  // Sign-in button handler
  document.getElementById('sign-in-btn')?.addEventListener('click', () => {
    const loginUrl = getLoginUrl('/me');
    if (loginUrl && loginUrl !== '#') {
      window.location.href = loginUrl;
    } else {
      alert('The tavern door is sealed! Ask Rudiger or your DM for help.');
    }
  });
</script>

<script define:vars={{ characterMap }}>
  const COGNITO_AUTH_KEY = 'dndblog-cognito-auth';

  // Character name lookup
  const characters = characterMap;

  function getCharacterName(slug) {
    return characters[slug]?.name || slug;
  }

  function checkAuth() {
    const loadingState = document.getElementById('loading-state');
    const unauthState = document.getElementById('unauthenticated-state');
    const authState = document.getElementById('authenticated-state');

    const cognitoAuth = localStorage.getItem(COGNITO_AUTH_KEY);

    if (!cognitoAuth) {
      loadingState.style.display = 'none';
      unauthState.style.display = 'flex';
      return;
    }

    try {
      const auth = JSON.parse(cognitoAuth);

      // Check if expired
      if (auth.expiresAt && auth.expiresAt < Date.now()) {
        localStorage.removeItem(COGNITO_AUTH_KEY);
        loadingState.style.display = 'none';
        unauthState.style.display = 'flex';
        return;
      }

      // User is authenticated
      loadingState.style.display = 'none';
      authState.style.display = 'block';

      // Set user name
      const userName = auth.email?.split('@')[0] || 'Adventurer';
      document.getElementById('user-name').textContent = userName;

      // Show DM section if DM
      if (auth.roles?.isDm) {
        document.getElementById('dm-section').style.display = 'block';
      }

      // Show player section if has character
      const characterSlug = auth.characterSlug;
      if (characterSlug) {
        document.getElementById('player-section').style.display = 'block';
        document.getElementById('session-tracker-link').href = `/campaign`;
        document.getElementById('character-name-badge').textContent = getCharacterName(characterSlug);
      }

    } catch (e) {
      console.error('Auth parse error:', e);
      loadingState.style.display = 'none';
      unauthState.style.display = 'flex';
    }
  }

  // Sign out handler
  document.getElementById('sign-out-btn')?.addEventListener('click', () => {
    localStorage.removeItem(COGNITO_AUTH_KEY);
    window.dispatchEvent(new Event('auth-change'));
    window.location.href = '/';
  });

  // Check auth on load
  checkAuth();

  // Listen for auth changes
  window.addEventListener('storage', checkAuth);
  window.addEventListener('auth-change', checkAuth);
</script>

<style>
  .dashboard {
    min-height: calc(100vh - var(--header-height) - 100px);
    padding: var(--space-xl) var(--space-lg);
    max-width: 900px;
    margin: 0 auto;
  }

  .dashboard-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  #loading-state {
    min-height: 300px;
    color: var(--color-text-muted);
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-gold);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: var(--space-md);
    will-change: transform;
  }

  @media (prefers-reduced-motion: reduce) {
    .loading-spinner {
      animation: none;
      border-top-color: var(--color-gold);
      border-right-color: var(--color-gold);
    }
  }

  .loading-text {
    font-style: italic;
    color: var(--color-text-muted);
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Auth prompt */
  .auth-prompt {
    text-align: center;
    padding: var(--space-2xl);
    max-width: 500px;
  }

  .auth-prompt h1 {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    color: var(--color-gold);
    margin: 0 0 var(--space-md);
  }

  .auth-prompt p {
    color: var(--color-text-secondary);
    margin: 0 0 var(--space-md);
    font-size: var(--text-base);
    line-height: 1.6;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-lg);
    border-radius: var(--radius-md);
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all var(--transition-fast);
    border: none;
    font-size: var(--text-base);
  }

  .btn-primary {
    background: var(--color-gold);
    color: var(--color-bg);
  }

  .btn-primary:hover {
    background: var(--color-gold-light, #d4b44a);
    transform: translateY(-2px);
  }

  .btn-large {
    padding: var(--space-md) var(--space-xl);
    font-size: var(--text-lg);
  }

  .btn-secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-bg-tertiary);
    color: var(--color-text);
  }

  .btn:focus-visible {
    outline: 2px solid var(--color-gold);
    outline-offset: 2px;
  }

  /* Dashboard header */
  .dashboard-header {
    text-align: center;
    margin-bottom: var(--space-2xl);
  }

  .tavern-welcome {
    font-family: var(--font-display);
    font-size: var(--text-sm);
    color: var(--color-gold);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: var(--space-sm);
  }

  .dashboard-title {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    color: var(--color-text);
    margin: 0 0 var(--space-sm);
  }

  .dashboard-title span {
    color: var(--color-gold);
  }

  /* Mission teaser */
  .mission-teaser {
    background: linear-gradient(135deg, var(--color-bg-secondary) 0%, var(--color-bg-tertiary) 100%);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-gold);
    border-radius: var(--radius-md);
    padding: var(--space-md) var(--space-lg);
    margin-bottom: var(--space-xl);
  }

  .mission-teaser__label {
    font-size: var(--text-xs);
    color: var(--color-gold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
    margin-bottom: var(--space-xs);
  }

  .mission-teaser__title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    color: var(--color-text);
    margin: 0 0 var(--space-sm);
  }

  .mission-teaser__summary {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
    line-height: 1.6;
    font-style: italic;
  }

  /* Dashboard grid */
  .dashboard-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .dashboard-section {
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    border: 1px solid var(--color-border);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-family: var(--font-display);
    font-size: var(--text-lg);
    color: var(--color-gold);
    margin: 0 0 var(--space-md);
  }

  .dashboard-section--dm {
    border-color: var(--color-gold);
    background: linear-gradient(135deg, var(--color-bg-secondary) 0%, rgba(var(--color-gold-rgb, 201, 162, 39), 0.05) 100%);
  }

  /* Action cards */
  .action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-md);
  }

  .action-card {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    transition: all var(--transition-fast);
  }

  .action-card:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .action-card:focus-visible {
    outline: 2px solid var(--color-gold);
    outline-offset: 2px;
  }

  .action-card--primary {
    background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-bg-secondary) 100%);
    border: 2px solid var(--color-accent);
  }

  .action-card--primary:hover {
    border-color: var(--color-gold);
    box-shadow: 0 4px 20px rgba(var(--color-accent-rgb, 99, 102, 241), 0.2);
  }

  .action-card--dm {
    border-color: var(--color-gold);
  }

  .action-card--dm:hover {
    border-color: var(--color-gold);
    box-shadow: 0 4px 20px rgba(var(--color-gold-rgb, 201, 162, 39), 0.2);
  }

  .action-content {
    flex: 1;
    min-width: 0;
  }

  .action-title {
    font-family: var(--font-display);
    font-size: var(--text-base);
    margin: 0 0 var(--space-xs);
    color: var(--color-text);
  }

  .action-card:hover .action-title {
    color: var(--color-accent);
  }

  .action-card--dm:hover .action-title {
    color: var(--color-gold);
  }

  .action-description {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
    line-height: 1.4;
  }

  .action-arrow {
    flex-shrink: 0;
    color: var(--color-text-muted);
  }

  .character-badge {
    display: inline-block;
    margin-top: var(--space-xs);
    padding: 2px var(--space-sm);
    background: var(--color-accent);
    color: white;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
  }

  .live-badge {
    display: inline-block;
    margin-top: var(--space-xs);
    padding: 2px var(--space-sm);
    background: var(--color-success, #22c55e);
    color: white;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
  }

  /* Account section */
  .account-section {
    margin-top: var(--space-2xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
  }

  @media (max-width: 640px) {
    .dashboard {
      padding: var(--space-md);
    }

    .action-grid {
      grid-template-columns: 1fr;
    }

    .action-card {
      flex-direction: column;
      text-align: center;
    }

    .action-arrow {
      display: none;
    }
  }
</style>
