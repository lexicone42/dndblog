---
/**
 * Tags Index Page
 *
 * Browse all content by tag - a core library science feature.
 * Displays a tag cloud with frequency-based sizing.
 */

import BaseLayout from '@layouts/BaseLayout.astro';
import BreadcrumbNav from '@components/BreadcrumbNav.astro';
import { getCollection } from 'astro:content';

// Fetch all collections that have tags
const [characters, enemies, locations, factions, items, blogs] = await Promise.all([
  getCollection('characters'),
  getCollection('enemies'),
  getCollection('locations'),
  getCollection('factions'),
  getCollection('items'),
  getCollection('blog'),
]);

// Type aliases
type CharacterEntry = typeof characters[0];
type EnemyEntry = typeof enemies[0];
type LocationEntry = typeof locations[0];
type FactionEntry = typeof factions[0];
type ItemEntry = typeof items[0];
type BlogEntry = typeof blogs[0];

// Build tag frequency map
const tagCounts = new Map<string, { count: number; entities: Array<{ name: string; path: string; type: string }> }>();

function addTags(
  tags: string[] | undefined,
  entityName: string,
  entityPath: string,
  entityType: string
) {
  if (!tags) return;
  for (const tag of tags) {
    const normalized = tag.toLowerCase().trim();
    if (!tagCounts.has(normalized)) {
      tagCounts.set(normalized, { count: 0, entities: [] });
    }
    const entry = tagCounts.get(normalized)!;
    entry.count++;
    entry.entities.push({ name: entityName, path: entityPath, type: entityType });
  }
}

// Process all entities
characters.forEach((e: CharacterEntry) => addTags(e.data.tags, e.data.name, `/campaign/characters/${e.id}`, 'character'));
enemies.forEach((e: EnemyEntry) => addTags(e.data.tags, e.data.name, `/campaign/enemies/${e.id}`, 'enemy'));
locations.forEach((e: LocationEntry) => addTags(e.data.tags, e.data.name, `/campaign/locations/${e.id}`, 'location'));
factions.forEach((e: FactionEntry) => addTags(e.data.tags, e.data.name, `/campaign/factions/${e.id}`, 'faction'));
items.forEach((e: ItemEntry) => addTags(e.data.tags, e.data.name, `/campaign/items/${e.id}`, 'item'));
blogs.forEach((e: BlogEntry) => addTags(e.data.tags, e.data.title, `/blog/${e.id}`, 'blog'));

// Sort tags by count (descending) then alphabetically
const sortedTags = Array.from(tagCounts.entries())
  .sort((a, b) => {
    if (b[1].count !== a[1].count) return b[1].count - a[1].count;
    return a[0].localeCompare(b[0]);
  });

// Calculate tag sizes based on frequency (logarithmic scale)
const maxCount = Math.max(...sortedTags.map(([_, data]) => data.count));
const minCount = Math.min(...sortedTags.map(([_, data]) => data.count));

function getTagSize(count: number): 'xs' | 'sm' | 'md' | 'lg' | 'xl' {
  if (maxCount === minCount) return 'md';
  const ratio = (count - minCount) / (maxCount - minCount);
  if (ratio > 0.8) return 'xl';
  if (ratio > 0.6) return 'lg';
  if (ratio > 0.4) return 'md';
  if (ratio > 0.2) return 'sm';
  return 'xs';
}

// Total counts
const totalTags = sortedTags.length;
const totalTagged = sortedTags.reduce((sum, [_, data]) => sum + data.count, 0);
---

<BaseLayout
  title="Browse by Tag - Campaign Reference"
  description="Browse all campaign content organized by subject tags."
>
  <div class="container">
    <BreadcrumbNav items={[
      { label: 'Home', href: '/' },
      { label: 'Reference', href: '/reference' },
      { label: 'Tags' },
    ]} />

    <header class="page-header">
      <h1 class="page-title">Browse by Tag</h1>
      <p class="page-description">
        {totalTags} subject tags across {totalTagged} tagged entries
      </p>
    </header>

    <section class="tag-cloud" aria-label="Tag cloud">
      <h2 class="sr-only">All Tags</h2>
      <div class="tag-cloud__container">
        {sortedTags.map(([tag, data]) => (
          <a
            href={`/tags/${encodeURIComponent(tag)}`}
            class={`tag-cloud__tag tag-cloud__tag--${getTagSize(data.count)}`}
            title={`${data.count} ${data.count === 1 ? 'entry' : 'entries'}`}
          >
            {tag}
            <span class="tag-cloud__count">({data.count})</span>
          </a>
        ))}
      </div>
    </section>

    <section class="tag-list" aria-label="Tags with entity counts">
      <h2 class="section-title">All Tags (Alphabetical)</h2>
      <div class="tag-list__grid">
        {Array.from(tagCounts.entries())
          .sort((a, b) => a[0].localeCompare(b[0]))
          .map(([tag, data]) => (
            <a href={`/tags/${encodeURIComponent(tag)}`} class="tag-list__item">
              <span class="tag-list__name">{tag}</span>
              <span class="tag-list__meta">
                {data.count} {data.count === 1 ? 'entry' : 'entries'}
              </span>
            </a>
          ))
        }
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  .page-header {
    text-align: center;
    padding: var(--space-xl) 0 var(--space-lg);
  }

  .page-title {
    font-size: var(--text-3xl);
    margin: 0 0 var(--space-sm);
  }

  .page-description {
    color: var(--color-text-secondary);
    font-size: var(--text-lg);
    margin: 0;
  }

  /* Tag Cloud */
  .tag-cloud {
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-2xl);
    margin-bottom: var(--space-2xl);
    border: 1px solid var(--color-border);
  }

  .tag-cloud__container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: var(--space-sm);
  }

  .tag-cloud__tag {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text-secondary);
    transition: all var(--transition-fast);
  }

  .tag-cloud__tag:hover {
    border-color: var(--color-gold);
    color: var(--color-gold);
    transform: translateY(-2px);
  }

  .tag-cloud__tag--xs {
    font-size: var(--text-xs);
    padding: 2px 6px;
  }

  .tag-cloud__tag--sm {
    font-size: var(--text-sm);
  }

  .tag-cloud__tag--md {
    font-size: var(--text-base);
  }

  .tag-cloud__tag--lg {
    font-size: var(--text-lg);
    font-weight: 600;
  }

  .tag-cloud__tag--xl {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-gold);
    border-color: var(--color-gold);
  }

  .tag-cloud__count {
    font-size: 0.8em;
    opacity: 0.7;
  }

  /* Alphabetical List */
  .section-title {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    color: var(--color-gold);
    margin: 0 0 var(--space-lg);
    padding-bottom: var(--space-sm);
    border-bottom: 2px solid var(--color-gold);
  }

  .tag-list__grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-sm);
  }

  .tag-list__item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .tag-list__item:hover {
    border-color: var(--color-accent);
    background: var(--color-bg-tertiary);
  }

  .tag-list__name {
    color: var(--color-text);
    font-weight: 500;
  }

  .tag-list__meta {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  @media (max-width: 640px) {
    .tag-cloud {
      padding: var(--space-lg);
    }

    .tag-list__grid {
      grid-template-columns: 1fr;
    }
  }
</style>
