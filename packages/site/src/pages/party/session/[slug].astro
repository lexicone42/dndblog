---
/**
 * Session Tracker Page
 * Allows players to track HP, spell slots, and conditions during a session.
 * Requires per-character token validation.
 */

import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';

// Generate static paths for all PC characters
export async function getStaticPaths() {
  const characters = await getCollection('characters');
  // Only create pages for PC characters (players)
  const pcCharacters = characters.filter((c: CollectionEntry<'characters'>) => c.data.subtype === 'pc');
  return pcCharacters.map((character: CollectionEntry<'characters'>) => ({
    params: { slug: character.id },
    props: { character },
  }));
}

type Props = {
  character: CollectionEntry<'characters'>;
};

const { character } = Astro.props as Props;
const slug = character.id;

// Get other active party members for the party view
const allCharacters = await getCollection('characters');
const partyMembers = allCharacters
  .filter((c: CollectionEntry<'characters'>) => c.data.subtype === 'pc' && c.data.status === 'active')
  .sort((a: CollectionEntry<'characters'>, b: CollectionEntry<'characters'>) => a.data.name.localeCompare(b.data.name))
  .map((c: CollectionEntry<'characters'>) => ({
    slug: c.id,
    name: c.data.name,
    level: c.data.level || 1,
    class: c.data.class || 'Unknown',
    race: c.data.race,
    isCurrentCharacter: c.id === slug,
  }));

// Standard D&D 5e conditions
const standardConditions = [
  'Blinded', 'Charmed', 'Deafened', 'Exhaustion', 'Frightened',
  'Grappled', 'Incapacitated', 'Invisible', 'Paralyzed', 'Petrified',
  'Poisoned', 'Prone', 'Restrained', 'Stunned', 'Unconscious'
];

// API URL for token validation and draft operations
const apiUrl = import.meta.env.PUBLIC_DM_NOTES_API_URL || '';

// Prepare character data for client
const characterData = {
  slug: character.id,
  name: character.data.name,
  level: character.data.level || 1,
  class: character.data.class || 'Unknown',
  combat: {
    hp: character.data.combat?.hp ?? character.data.combat?.maxHp ?? 10,
    maxHp: character.data.combat?.maxHp ?? 10,
    tempHp: character.data.combat?.tempHp ?? 0,
  },
  spellcasting: character.data.spellcasting ? {
    spellSlots: character.data.spellcasting.spellSlots || [],
    pactSlots: character.data.spellcasting.pactSlots || null,
  } : null,
  activeConditions: character.data.activeConditions || [],
  features: (character.data.features || [])
    .filter((f: { uses?: { current?: number; max?: number; recharge?: string } }) => f.uses)
    .map((f: { name: string; uses: { current?: number; max?: number; recharge?: string } }) => ({
      name: f.name,
      current: f.uses?.current ?? f.uses?.max ?? 0,
      max: f.uses?.max ?? 0,
      recharge: f.uses?.recharge ?? 'long-rest',
    })),
  deathSaves: {
    successes: 0,
    failures: 0,
  },
};
---

<BaseLayout
  title={`${character.data.name} - Character Dashboard`}
  description={`Character dashboard for ${character.data.name} - track HP, spell slots, and conditions`}
>
  <div class="session-tracker" data-character-slug={slug}>
    <!-- Auth Gate -->
    <div id="auth-gate" class="auth-gate">
      <div class="auth-content">
        <div class="auth-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>
        <h1 class="auth-title">{character.data.name}</h1>
        <p class="auth-description">Enter your player token to access the session tracker.</p>
        <form id="auth-form" class="auth-form">
          <label for="player-token" class="visually-hidden">Player Token</label>
          <input
            type="password"
            id="player-token"
            class="auth-input"
            placeholder="Enter player token..."
            autocomplete="off"
            required
          />
          <button type="submit" class="auth-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
              <polyline points="10 17 15 12 10 7"></polyline>
              <line x1="15" y1="12" x2="3" y2="12"></line>
            </svg>
            Enter
          </button>
        </form>
        <p id="auth-error" class="auth-error" style="display: none;"></p>
      </div>
    </div>

    <!-- Character Dashboard Content -->
    <div id="tracker-content" class="tracker-content" style="display: none;">
      <header class="tracker-header">
        <div class="header-main">
          <div class="character-identity">
            <h1 class="tracker-title">{character.data.name}</h1>
            <div class="character-details">
              <span class="character-level">Level {character.data.level}</span>
              <span class="character-class">{character.data.class}{character.data.subclass && ` (${character.data.subclass})`}</span>
              {character.data.race && <span class="character-race">{character.data.race}</span>}
            </div>
          </div>
          <div id="draft-indicator" class="draft-indicator" style="display: none;">
            <span class="draft-badge draft-badge--unsaved">Unsaved</span>
            <span class="draft-badge draft-badge--saving" style="display: none;">Saving...</span>
            <span class="draft-badge draft-badge--saved" style="display: none;">Saved ‚úì</span>
          </div>
        </div>
        <nav class="dashboard-nav">
          <a href={`/campaign/characters/${character.id}`} class="nav-link nav-link--sheet" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            Full Character Sheet
          </a>
          <button id="show-party-btn" class="nav-link nav-link--party">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            View Party
          </button>
        </nav>
      </header>

      <!-- HP Section -->
      <section class="hp-section">
        <h2 class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
          Hit Points
        </h2>

        <div class="hp-display">
          <div class="hp-main">
            <button id="hp-minus-10" class="hp-btn hp-btn--large" data-change="-10">-10</button>
            <button id="hp-minus" class="hp-btn" data-change="-1">-1</button>
            <div class="hp-value-container">
              <input type="number" id="hp-current" class="hp-input" value={characterData.combat.hp} min="0" />
              <span class="hp-separator">/</span>
              <span id="hp-max" class="hp-max">{characterData.combat.maxHp}</span>
            </div>
            <button id="hp-plus" class="hp-btn" data-change="1">+1</button>
            <button id="hp-plus-10" class="hp-btn hp-btn--large" data-change="10">+10</button>
          </div>
          <div id="hp-bar" class="hp-bar">
            <div class="hp-bar-fill" style={`width: ${Math.min(100, (characterData.combat.hp / characterData.combat.maxHp) * 100)}%`}></div>
          </div>
        </div>

        <div class="temp-hp-section">
          <label for="temp-hp" class="temp-hp-label">Temporary HP</label>
          <div class="temp-hp-controls">
            <button id="temp-hp-minus" class="hp-btn hp-btn--small" data-change="-1">-</button>
            <input type="number" id="temp-hp" class="temp-hp-input" value={characterData.combat.tempHp} min="0" />
            <button id="temp-hp-plus" class="hp-btn hp-btn--small" data-change="1">+</button>
          </div>
        </div>

        <div class="quick-damage">
          <input type="number" id="damage-amount" class="damage-input" placeholder="Amount" min="1" />
          <button id="take-damage" class="damage-btn damage-btn--hurt">Take Damage</button>
          <button id="heal" class="damage-btn damage-btn--heal">Heal</button>
        </div>
      </section>

      <!-- Spell Slots Section (only for casters) -->
      {characterData.spellcasting && characterData.spellcasting.spellSlots.length > 0 && (
        <section class="spell-slots-section">
          <h2 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
            </svg>
            Spell Slots
          </h2>

          <div id="spell-slots-container" class="spell-slots-grid">
            {characterData.spellcasting.spellSlots.map((slot: { level: number; total: number; expended: number }) => (
              <div class="slot-row" data-level={slot.level}>
                <span class="slot-level">Level {slot.level}</span>
                <div class="slot-pips">
                  {[...Array(slot.total)].map((_, i) => (
                    <button
                      class={`slot-pip ${i < slot.expended ? 'slot-pip--expended' : ''}`}
                      data-index={i}
                      data-level={slot.level}
                      title={i < slot.expended ? 'Restore slot' : 'Expend slot'}
                    >
                      <span class="pip-fill"></span>
                    </button>
                  ))}
                </div>
                <span class="slot-count">{slot.total - slot.expended}/{slot.total}</span>
              </div>
            ))}
          </div>

          {(() => {
            const pactSlots = characterData.spellcasting?.pactSlots;
            if (!pactSlots) return null;
            return (
              <div id="pact-slots-container" class="pact-slots">
                <div class="slot-row" data-pact="true">
                  <span class="slot-level">Pact Slots (Lvl {pactSlots.level})</span>
                  <div class="slot-pips">
                    {[...Array(pactSlots.total)].map((_, i) => (
                      <button
                        class={`slot-pip slot-pip--pact ${i < pactSlots.expended ? 'slot-pip--expended' : ''}`}
                        data-index={i}
                        data-pact="true"
                        title={i < pactSlots.expended ? 'Restore pact slot' : 'Expend pact slot'}
                      >
                        <span class="pip-fill"></span>
                      </button>
                    ))}
                  </div>
                  <span class="slot-count">{pactSlots.total - pactSlots.expended}/{pactSlots.total}</span>
                </div>
              </div>
            );
          })()}
        </section>
      )}

      <!-- Death Saves Section (only shows when HP = 0) -->
      <section id="death-saves-section" class="death-saves-section" style="display: none;">
        <h2 class="section-title section-title--danger">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
            <path d="M9 9h.01"></path>
            <path d="M15 9h.01"></path>
            <path d="M8 13c0 2 2 4 4 4s4-2 4-4"></path>
          </svg>
          Death Saves
        </h2>

        <div class="death-saves-container">
          <div class="death-saves-row">
            <span class="death-saves-label death-saves-label--success">Successes</span>
            <div class="death-saves-pips" data-type="successes">
              <button class="death-pip" data-index="0" title="Toggle success"><span class="pip-marker">‚óè</span></button>
              <button class="death-pip" data-index="1" title="Toggle success"><span class="pip-marker">‚óè</span></button>
              <button class="death-pip" data-index="2" title="Toggle success"><span class="pip-marker">‚óè</span></button>
            </div>
            <span id="death-successes-count" class="death-saves-count">(0/3)</span>
          </div>
          <div class="death-saves-row">
            <span class="death-saves-label death-saves-label--failure">Failures</span>
            <div class="death-saves-pips" data-type="failures">
              <button class="death-pip death-pip--failure" data-index="0" title="Toggle failure"><span class="pip-marker">‚óè</span></button>
              <button class="death-pip death-pip--failure" data-index="1" title="Toggle failure"><span class="pip-marker">‚óè</span></button>
              <button class="death-pip death-pip--failure" data-index="2" title="Toggle failure"><span class="pip-marker">‚óè</span></button>
            </div>
            <span id="death-failures-count" class="death-saves-count">(0/3)</span>
          </div>
        </div>

        <div class="death-saves-actions">
          <button id="death-success-btn" class="death-action-btn death-action-btn--success">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            +Success
          </button>
          <button id="death-failure-btn" class="death-action-btn death-action-btn--failure">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            +Failure
          </button>
          <button id="stabilize-btn" class="death-action-btn death-action-btn--stabilize">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            Stabilize
          </button>
        </div>
      </section>

      <!-- Features Section (only for characters with trackable features) -->
      {characterData.features.length > 0 && (
        <section class="features-section">
          <h2 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
            Class Features
          </h2>

          <div id="features-container" class="features-grid">
            {characterData.features.map((feature: { name: string; current: number; max: number; recharge: string }) => (
              <div class="feature-row" data-feature={feature.name} data-recharge={feature.recharge}>
                <div class="feature-info">
                  <span class="feature-name">{feature.name}</span>
                  <span class={`feature-recharge feature-recharge--${feature.recharge}`}>
                    {feature.recharge === 'short-rest' ? 'Short Rest' : 'Long Rest'}
                  </span>
                </div>
                <div class="feature-pips">
                  {[...Array(feature.max)].map((_, i) => (
                    <button
                      class={`feature-pip ${i >= feature.current ? 'feature-pip--used' : ''}`}
                      data-index={i}
                      data-feature={feature.name}
                      title={i >= feature.current ? 'Restore use' : 'Use feature'}
                    >
                      <span class="pip-fill"></span>
                    </button>
                  ))}
                </div>
                <span class="feature-count">{feature.current}/{feature.max}</span>
              </div>
            ))}
          </div>
        </section>
      )}

      <!-- Conditions Section -->
      <section class="conditions-section">
        <h2 class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          Active Conditions
        </h2>

        <div id="conditions-list" class="conditions-list">
          {characterData.activeConditions.length === 0 ? (
            <p class="no-conditions">No active conditions</p>
          ) : (
            characterData.activeConditions.map((condition: { name: string; source?: string; duration?: string; concentration?: boolean; beneficial?: boolean; notes?: string }, index: number) => (
              <div class={`condition-tag ${condition.beneficial ? 'condition-tag--beneficial' : ''}`} data-index={index}>
                {condition.concentration && <span class="concentration-icon" title="Concentration">C</span>}
                <span class="condition-name">{condition.name}</span>
                {condition.source && <span class="condition-source">({condition.source})</span>}
                <button class="condition-remove" data-index={index} title="Remove condition">√ó</button>
              </div>
            ))
          )}
        </div>

        <div class="add-condition">
          <select id="condition-select" class="condition-select">
            <option value="">Add condition...</option>
            <optgroup label="Standard Conditions">
              {standardConditions.map(c => <option value={c}>{c}</option>)}
            </optgroup>
            <option value="custom">Custom...</option>
          </select>
          <input type="text" id="custom-condition" class="custom-condition-input" placeholder="Custom condition name..." style="display: none;" />
          <label class="concentration-checkbox">
            <input type="checkbox" id="condition-concentration" />
            <span>Concentration</span>
          </label>
          <label class="beneficial-checkbox">
            <input type="checkbox" id="condition-beneficial" />
            <span>Beneficial</span>
          </label>
          <button id="add-condition-btn" class="add-condition-btn">Add</button>
        </div>
      </section>

      <!-- Rest Section -->
      <section class="rest-section">
        <h2 class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          Rest
        </h2>

        <div class="rest-buttons">
          <button id="short-rest-btn" class="rest-btn rest-btn--short">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Short Rest
          </button>
          <button id="long-rest-btn" class="rest-btn rest-btn--long">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
            Long Rest
          </button>
        </div>
      </section>

      <!-- Footer with Save -->
      <footer class="tracker-footer">
        <button id="save-draft-btn" class="save-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Save Draft
        </button>
        <span id="save-status" class="save-status"></span>
        <button id="logout-btn" class="logout-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Sign Out
        </button>
      </footer>
    </div>

    <!-- Party Modal -->
    <div id="party-modal" class="party-modal" style="display: none;">
      <div class="party-modal-backdrop"></div>
      <div class="party-modal-content">
        <div class="party-modal-header">
          <h2>The Party</h2>
          <button id="close-party-modal" class="modal-close">√ó</button>
        </div>
        <div class="party-modal-body">
          <div class="party-list">
            {partyMembers.map((member: { slug: string; name: string; level: number; class: string; race?: string; isCurrentCharacter: boolean }) => (
              <a
                href={`/party/session/${member.slug}`}
                class={`party-member ${member.isCurrentCharacter ? 'party-member--current' : ''}`}
              >
                <div class="party-member-info">
                  <span class="party-member-name">{member.name}</span>
                  <span class="party-member-details">
                    Level {member.level} {member.class}
                    {member.race && ` ‚Ä¢ ${member.race}`}
                  </span>
                </div>
                {member.isCurrentCharacter && <span class="current-badge">You</span>}
              </a>
            ))}
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline define:vars={{ apiUrl, characterData, standardConditions }}>
(function() {
  var TOKEN_KEY = 'player-token';
  var CHARACTER_SLUG = characterData.slug;
  var API_URL = apiUrl;

  // State
  var state = {
    hp: characterData.combat.hp,
    maxHp: characterData.combat.maxHp,
    tempHp: characterData.combat.tempHp,
    spellSlots: characterData.spellcasting ? [...characterData.spellcasting.spellSlots] : [],
    pactSlots: characterData.spellcasting?.pactSlots ? {...characterData.spellcasting.pactSlots} : null,
    activeConditions: [...characterData.activeConditions],
    features: characterData.features.map(function(f) { return {...f}; }),
    deathSaves: { successes: 0, failures: 0 },
    isDirty: false,
    isAutoSaving: false,
  };

  // Auto-save configuration
  var AUTO_SAVE_DELAY = 3000; // 3 seconds
  var autoSaveTimeout = null;

  // DOM Elements
  var authGate = document.getElementById('auth-gate');
  var trackerContent = document.getElementById('tracker-content');
  var authForm = document.getElementById('auth-form');
  var authError = document.getElementById('auth-error');
  var tokenInput = document.getElementById('player-token');
  var draftIndicator = document.getElementById('draft-indicator');
  var saveStatus = document.getElementById('save-status');

  // ============================================
  // Authentication
  // ============================================

  async function validateCharacterToken(token) {
    if (!API_URL) {
      console.warn('API URL not configured');
      return { valid: false };
    }

    try {
      var response = await fetch(API_URL + '/validate-character-token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Player-Token': token,
        },
      });

      if (!response.ok) return { valid: false };
      return await response.json();
    } catch (error) {
      console.error('Token validation error:', error);
      return { valid: false };
    }
  }

  async function checkAuth() {
    var token = localStorage.getItem(TOKEN_KEY);
    if (token) {
      var result = await validateCharacterToken(token);
      if (result.valid && result.characterSlug === CHARACTER_SLUG) {
        showTracker();
        loadDraft();
      } else if (result.valid) {
        showAuthError('This token is for ' + result.characterSlug + ', not ' + CHARACTER_SLUG);
      } else {
        localStorage.removeItem(TOKEN_KEY);
        showAuthGate();
      }
    }
  }

  function showTracker() {
    authGate.style.display = 'none';
    trackerContent.style.display = 'block';
    // Set initial HP bar state
    updateHpDisplay();
  }

  function showAuthGate() {
    authGate.style.display = 'flex';
    trackerContent.style.display = 'none';
  }

  function showAuthError(message) {
    authError.textContent = message;
    authError.style.display = 'block';
  }

  authForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    var token = tokenInput.value.trim();

    if (token) {
      authError.style.display = 'none';
      var result = await validateCharacterToken(token);

      if (result.valid && result.characterSlug === CHARACTER_SLUG) {
        localStorage.setItem(TOKEN_KEY, token);
        showTracker();
        loadDraft();
      } else if (result.valid) {
        showAuthError('This token is for ' + result.characterSlug + ', not ' + CHARACTER_SLUG);
      } else {
        showAuthError('Invalid token. Please try again.');
      }
    }
  });

  document.getElementById('logout-btn').addEventListener('click', function() {
    localStorage.removeItem(TOKEN_KEY);
    showAuthGate();
    tokenInput.value = '';
  });

  // ============================================
  // Party Modal
  // ============================================

  var partyModal = document.getElementById('party-modal');
  var showPartyBtn = document.getElementById('show-party-btn');
  var closePartyModalBtn = document.getElementById('close-party-modal');
  var partyModalBackdrop = partyModal.querySelector('.party-modal-backdrop');

  function showPartyModal() {
    partyModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function hidePartyModal() {
    partyModal.style.display = 'none';
    document.body.style.overflow = '';
  }

  showPartyBtn.addEventListener('click', showPartyModal);
  closePartyModalBtn.addEventListener('click', hidePartyModal);
  partyModalBackdrop.addEventListener('click', hidePartyModal);

  // Close on escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && partyModal.style.display === 'flex') {
      hidePartyModal();
    }
  });

  // ============================================
  // HP Controls
  // ============================================

  var hpInput = document.getElementById('hp-current');
  var hpBar = document.querySelector('.hp-bar-fill');
  var tempHpInput = document.getElementById('temp-hp');

  function updateHpDisplay() {
    hpInput.value = state.hp;
    var percent = Math.min(100, (state.hp / state.maxHp) * 100);
    hpBar.style.width = percent + '%';

    // Apply HP bar class based on health percentage
    var hpBarContainer = document.getElementById('hp-bar');
    hpBarContainer.classList.remove('hp-bar--critical', 'hp-bar--warning', 'hp-bar--healthy');

    if (percent <= 25) {
      hpBarContainer.classList.add('hp-bar--critical');
    } else if (percent <= 50) {
      hpBarContainer.classList.add('hp-bar--warning');
    } else {
      hpBarContainer.classList.add('hp-bar--healthy');
    }

    // Show/hide death saves section based on HP
    var wasAtZero = deathSavesSection && deathSavesSection.style.display !== 'none';
    var isNowAtZero = state.hp === 0;

    if (deathSavesSection) {
      deathSavesSection.style.display = isNowAtZero ? 'block' : 'none';
    }

    // If HP went from 0 to positive, reset death saves
    if (wasAtZero && !isNowAtZero && state.hp > 0) {
      state.deathSaves = { successes: 0, failures: 0 };
      updateDeathSavesDisplay();
    }

    markDirty();
  }

  function changeHp(amount) {
    state.hp = Math.max(0, Math.min(state.maxHp, state.hp + amount));
    updateHpDisplay();
  }

  // HP buttons
  document.querySelectorAll('.hp-btn[data-change]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var change = parseInt(this.dataset.change);
      if (this.id.startsWith('temp-hp')) {
        state.tempHp = Math.max(0, state.tempHp + change);
        tempHpInput.value = state.tempHp;
        markDirty();
      } else {
        changeHp(change);
      }
    });
  });

  hpInput.addEventListener('change', function() {
    state.hp = Math.max(0, Math.min(state.maxHp, parseInt(this.value) || 0));
    updateHpDisplay();
  });

  tempHpInput.addEventListener('change', function() {
    state.tempHp = Math.max(0, parseInt(this.value) || 0);
    markDirty();
  });

  // Quick damage/heal
  document.getElementById('take-damage').addEventListener('click', function() {
    var amount = parseInt(document.getElementById('damage-amount').value) || 0;
    if (amount > 0) {
      // Damage temp HP first
      if (state.tempHp > 0) {
        var tempDamage = Math.min(state.tempHp, amount);
        state.tempHp -= tempDamage;
        amount -= tempDamage;
        tempHpInput.value = state.tempHp;
      }
      if (amount > 0) {
        changeHp(-amount);
      }
      document.getElementById('damage-amount').value = '';
    }
  });

  document.getElementById('heal').addEventListener('click', function() {
    var amount = parseInt(document.getElementById('damage-amount').value) || 0;
    if (amount > 0) {
      changeHp(amount);
      document.getElementById('damage-amount').value = '';
    }
  });

  // ============================================
  // Spell Slots
  // ============================================

  function updateSlotDisplay() {
    state.spellSlots.forEach(function(slot) {
      var row = document.querySelector('.slot-row[data-level="' + slot.level + '"]');
      if (!row) return;

      var pips = row.querySelectorAll('.slot-pip');
      pips.forEach(function(pip, i) {
        pip.classList.toggle('slot-pip--expended', i < slot.expended);
      });

      var count = row.querySelector('.slot-count');
      if (count) count.textContent = (slot.total - slot.expended) + '/' + slot.total;
    });

    if (state.pactSlots) {
      var pactRow = document.querySelector('.slot-row[data-pact="true"]');
      if (pactRow) {
        var pactPips = pactRow.querySelectorAll('.slot-pip');
        pactPips.forEach(function(pip, i) {
          pip.classList.toggle('slot-pip--expended', i < state.pactSlots.expended);
        });
        var pactCount = pactRow.querySelector('.slot-count');
        if (pactCount) pactCount.textContent = (state.pactSlots.total - state.pactSlots.expended) + '/' + state.pactSlots.total;
      }
    }

    markDirty();
  }

  document.querySelectorAll('.slot-pip').forEach(function(pip) {
    pip.addEventListener('click', function() {
      var index = parseInt(this.dataset.index);
      var isPact = this.dataset.pact === 'true';

      if (isPact && state.pactSlots) {
        // Toggle pact slot
        if (index < state.pactSlots.expended) {
          state.pactSlots.expended = index;
        } else {
          state.pactSlots.expended = index + 1;
        }
      } else {
        var level = parseInt(this.dataset.level);
        var slot = state.spellSlots.find(function(s) { return s.level === level; });
        if (slot) {
          // Toggle slot
          if (index < slot.expended) {
            slot.expended = index;
          } else {
            slot.expended = index + 1;
          }
        }
      }

      updateSlotDisplay();
    });
  });

  // ============================================
  // Conditions
  // ============================================

  var conditionsList = document.getElementById('conditions-list');
  var conditionSelect = document.getElementById('condition-select');
  var customConditionInput = document.getElementById('custom-condition');

  function createConditionElement(condition, index) {
    var div = document.createElement('div');
    div.className = 'condition-tag' + (condition.beneficial ? ' condition-tag--beneficial' : '');
    div.setAttribute('data-index', index);

    if (condition.concentration) {
      var concIcon = document.createElement('span');
      concIcon.className = 'concentration-icon';
      concIcon.title = 'Concentration';
      concIcon.textContent = 'C';
      div.appendChild(concIcon);
    }

    var nameSpan = document.createElement('span');
    nameSpan.className = 'condition-name';
    nameSpan.textContent = condition.name;
    div.appendChild(nameSpan);

    if (condition.source) {
      var sourceSpan = document.createElement('span');
      sourceSpan.className = 'condition-source';
      sourceSpan.textContent = '(' + condition.source + ')';
      div.appendChild(sourceSpan);
    }

    var removeBtn = document.createElement('button');
    removeBtn.className = 'condition-remove';
    removeBtn.setAttribute('data-index', index);
    removeBtn.title = 'Remove condition';
    removeBtn.textContent = '√ó';
    removeBtn.addEventListener('click', function() {
      state.activeConditions.splice(index, 1);
      renderConditions();
      markDirty();
    });
    div.appendChild(removeBtn);

    return div;
  }

  function renderConditions() {
    // Clear the list
    while (conditionsList.firstChild) {
      conditionsList.removeChild(conditionsList.firstChild);
    }

    if (state.activeConditions.length === 0) {
      var p = document.createElement('p');
      p.className = 'no-conditions';
      p.textContent = 'No active conditions';
      conditionsList.appendChild(p);
    } else {
      state.activeConditions.forEach(function(condition, index) {
        conditionsList.appendChild(createConditionElement(condition, index));
      });
    }
  }

  conditionSelect.addEventListener('change', function() {
    customConditionInput.style.display = this.value === 'custom' ? 'block' : 'none';
  });

  document.getElementById('add-condition-btn').addEventListener('click', function() {
    var name = conditionSelect.value === 'custom'
      ? customConditionInput.value.trim()
      : conditionSelect.value;

    if (!name) return;

    state.activeConditions.push({
      name: name,
      concentration: document.getElementById('condition-concentration').checked,
      beneficial: document.getElementById('condition-beneficial').checked,
    });

    renderConditions();
    markDirty();

    // Reset
    conditionSelect.value = '';
    customConditionInput.value = '';
    customConditionInput.style.display = 'none';
    document.getElementById('condition-concentration').checked = false;
    document.getElementById('condition-beneficial').checked = false;
  });

  // Initial remove handlers for server-rendered conditions
  conditionsList.querySelectorAll('.condition-remove').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var idx = parseInt(this.dataset.index);
      state.activeConditions.splice(idx, 1);
      renderConditions();
      markDirty();
    });
  });

  // ============================================
  // Rest
  // ============================================

  document.getElementById('short-rest-btn').addEventListener('click', function() {
    if (confirm('Take a short rest? This will restore Warlock pact slots and short rest features.')) {
      // Restore pact slots
      if (state.pactSlots) {
        state.pactSlots.expended = 0;
      }
      // Restore short rest features
      state.features.forEach(function(f) {
        if (f.recharge === 'short-rest') {
          f.current = f.max;
        }
      });
      updateSlotDisplay();
      updateFeaturesDisplay();
      markDirty();
      saveStatus.textContent = 'Short rest taken';
      setTimeout(function() { saveStatus.textContent = ''; }, 2000);
    }
  });

  document.getElementById('long-rest-btn').addEventListener('click', function() {
    if (confirm('Take a long rest? This will restore all HP, spell slots, features, and clear conditions/death saves.')) {
      // Restore HP
      state.hp = state.maxHp;
      state.tempHp = 0;
      tempHpInput.value = 0;
      updateHpDisplay();

      // Restore all spell slots
      state.spellSlots.forEach(function(slot) {
        slot.expended = 0;
      });
      if (state.pactSlots) {
        state.pactSlots.expended = 0;
      }
      updateSlotDisplay();

      // Restore all features
      state.features.forEach(function(f) {
        f.current = f.max;
      });
      updateFeaturesDisplay();

      // Reset death saves
      state.deathSaves = { successes: 0, failures: 0 };
      updateDeathSavesDisplay();

      // Clear non-permanent conditions (keep only beneficial ones marked as "permanent")
      state.activeConditions = state.activeConditions.filter(function(c) {
        return c.duration === 'permanent';
      });
      renderConditions();

      markDirty();
      saveStatus.textContent = 'Long rest taken - fully restored!';
      setTimeout(function() { saveStatus.textContent = ''; }, 3000);
    }
  });

  // ============================================
  // Features
  // ============================================

  function updateFeaturesDisplay() {
    state.features.forEach(function(feature) {
      var row = document.querySelector('.feature-row[data-feature="' + feature.name + '"]');
      if (!row) return;

      var pips = row.querySelectorAll('.feature-pip');
      pips.forEach(function(pip, i) {
        pip.classList.toggle('feature-pip--used', i >= feature.current);
      });

      var count = row.querySelector('.feature-count');
      if (count) count.textContent = feature.current + '/' + feature.max;
    });
  }

  document.querySelectorAll('.feature-pip').forEach(function(pip) {
    pip.addEventListener('click', function() {
      var featureName = this.dataset.feature;
      var index = parseInt(this.dataset.index);
      var feature = state.features.find(function(f) { return f.name === featureName; });

      if (!feature) return;

      // Toggle: if clicking on an available pip (index < current), use it
      // If clicking on a used pip (index >= current), restore up to that point
      if (index < feature.current) {
        feature.current = index;
      } else {
        feature.current = index + 1;
      }

      updateFeaturesDisplay();
      markDirty();
    });
  });

  // ============================================
  // Death Saves
  // ============================================

  var deathSavesSection = document.getElementById('death-saves-section');

  function updateDeathSavesDisplay() {
    // Update success pips
    var successPips = document.querySelectorAll('.death-saves-pips[data-type="successes"] .death-pip');
    successPips.forEach(function(pip, i) {
      pip.classList.toggle('death-pip--filled', i < state.deathSaves.successes);
    });
    var successCount = document.getElementById('death-successes-count');
    if (successCount) successCount.textContent = '(' + state.deathSaves.successes + '/3)';

    // Update failure pips
    var failurePips = document.querySelectorAll('.death-saves-pips[data-type="failures"] .death-pip');
    failurePips.forEach(function(pip, i) {
      pip.classList.toggle('death-pip--filled', i < state.deathSaves.failures);
    });
    var failureCount = document.getElementById('death-failures-count');
    if (failureCount) failureCount.textContent = '(' + state.deathSaves.failures + '/3)';

    // Show/hide section based on HP
    if (deathSavesSection) {
      deathSavesSection.style.display = state.hp === 0 ? 'block' : 'none';
    }
  }

  // Death save pip click handlers
  document.querySelectorAll('.death-saves-pips[data-type="successes"] .death-pip').forEach(function(pip) {
    pip.addEventListener('click', function() {
      var index = parseInt(this.dataset.index);
      if (index < state.deathSaves.successes) {
        state.deathSaves.successes = index;
      } else {
        state.deathSaves.successes = Math.min(3, index + 1);
      }
      updateDeathSavesDisplay();
      markDirty();
    });
  });

  document.querySelectorAll('.death-saves-pips[data-type="failures"] .death-pip').forEach(function(pip) {
    pip.addEventListener('click', function() {
      var index = parseInt(this.dataset.index);
      if (index < state.deathSaves.failures) {
        state.deathSaves.failures = index;
      } else {
        state.deathSaves.failures = Math.min(3, index + 1);
      }
      updateDeathSavesDisplay();
      markDirty();
    });
  });

  // Quick action buttons
  var deathSuccessBtn = document.getElementById('death-success-btn');
  var deathFailureBtn = document.getElementById('death-failure-btn');
  var stabilizeBtn = document.getElementById('stabilize-btn');

  if (deathSuccessBtn) {
    deathSuccessBtn.addEventListener('click', function() {
      if (state.deathSaves.successes < 3) {
        state.deathSaves.successes++;
        updateDeathSavesDisplay();
        markDirty();

        if (state.deathSaves.successes >= 3) {
          saveStatus.textContent = 'Stabilized! Character is unconscious but stable.';
          setTimeout(function() { saveStatus.textContent = ''; }, 3000);
        }
      }
    });
  }

  if (deathFailureBtn) {
    deathFailureBtn.addEventListener('click', function() {
      if (state.deathSaves.failures < 3) {
        state.deathSaves.failures++;
        updateDeathSavesDisplay();
        markDirty();

        if (state.deathSaves.failures >= 3) {
          saveStatus.textContent = 'üíÄ Character has died...';
          saveStatus.className = 'save-status save-status--error';
          setTimeout(function() {
            saveStatus.textContent = '';
            saveStatus.className = 'save-status';
          }, 5000);
        }
      }
    });
  }

  if (stabilizeBtn) {
    stabilizeBtn.addEventListener('click', function() {
      state.deathSaves.successes = 3;
      state.deathSaves.failures = 0;
      updateDeathSavesDisplay();
      markDirty();
      saveStatus.textContent = 'Stabilized! Character is unconscious but stable.';
      setTimeout(function() { saveStatus.textContent = ''; }, 3000);
    });
  }

  // ============================================
  // Draft Save/Load
  // ============================================

  function scheduleAutoSave() {
    if (autoSaveTimeout) {
      clearTimeout(autoSaveTimeout);
    }
    autoSaveTimeout = setTimeout(function() {
      autoSaveDraft();
    }, AUTO_SAVE_DELAY);
  }

  function showDraftBadge(type) {
    var badges = draftIndicator.querySelectorAll('.draft-badge');
    badges.forEach(function(b) { b.style.display = 'none'; });
    var badge = draftIndicator.querySelector('.draft-badge--' + type);
    if (badge) badge.style.display = 'inline-flex';
    draftIndicator.style.display = 'inline-flex';
  }

  function markDirty() {
    state.isDirty = true;
    if (!state.isAutoSaving) {
      showDraftBadge('unsaved');
    }
    scheduleAutoSave();
  }

  async function autoSaveDraft() {
    if (!state.isDirty) return;
    state.isAutoSaving = true;
    showDraftBadge('saving');

    await saveDraft(true); // true = silent mode

    state.isAutoSaving = false;
    if (!state.isDirty) {
      showDraftBadge('saved');
      setTimeout(function() {
        if (!state.isDirty) {
          draftIndicator.style.display = 'none';
        }
      }, 2000);
    }
  }

  async function saveDraft(silent) {
    var token = localStorage.getItem(TOKEN_KEY);
    if (!token || !API_URL) return;

    var draft = {
      characterSlug: CHARACTER_SLUG,
      combat: {
        hp: state.hp,
        tempHp: state.tempHp,
      },
      spellSlots: state.spellSlots,
      pactSlots: state.pactSlots,
      activeConditions: state.activeConditions,
      features: state.features,
      deathSaves: state.deathSaves,
    };

    try {
      var response = await fetch(API_URL + '/player/drafts/' + CHARACTER_SLUG, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Player-Token': token,
        },
        body: JSON.stringify(draft),
      });

      if (response.ok) {
        state.isDirty = false;
        if (!silent) {
          draftIndicator.style.display = 'none';
          saveStatus.textContent = 'Draft saved!';
          saveStatus.className = 'save-status save-status--success';
        }
      } else {
        if (!silent) {
          saveStatus.textContent = 'Failed to save draft';
          saveStatus.className = 'save-status save-status--error';
        }
      }
    } catch (error) {
      console.error('Save error:', error);
      if (!silent) {
        saveStatus.textContent = 'Error saving draft';
        saveStatus.className = 'save-status save-status--error';
      }
    }

    if (!silent) {
      setTimeout(function() {
        saveStatus.textContent = '';
        saveStatus.className = 'save-status';
      }, 3000);
    }
  }

  async function loadDraft() {
    var token = localStorage.getItem(TOKEN_KEY);
    if (!token || !API_URL) return;

    try {
      var response = await fetch(API_URL + '/player/drafts/' + CHARACTER_SLUG, {
        method: 'GET',
        headers: {
          'X-Player-Token': token,
        },
      });

      if (response.ok) {
        var draft = await response.json();
        if (draft && draft.combat) {
          state.hp = draft.combat.hp;
          state.tempHp = draft.combat.tempHp || 0;
          tempHpInput.value = state.tempHp;
          updateHpDisplay();
        }
        if (draft && draft.spellSlots) {
          state.spellSlots = draft.spellSlots;
          updateSlotDisplay();
        }
        if (draft && draft.pactSlots) {
          state.pactSlots = draft.pactSlots;
          updateSlotDisplay();
        }
        if (draft && draft.activeConditions) {
          state.activeConditions = draft.activeConditions;
          renderConditions();
        }
        if (draft && draft.features) {
          state.features = draft.features;
          updateFeaturesDisplay();
        }
        if (draft && draft.deathSaves) {
          state.deathSaves = draft.deathSaves;
          updateDeathSavesDisplay();
        }

        // Don't mark dirty since we just loaded
        state.isDirty = false;
        draftIndicator.style.display = 'none';
      }
    } catch (error) {
      console.log('No draft found or error loading:', error);
    }
  }

  document.getElementById('save-draft-btn').addEventListener('click', function() {
    saveDraft(false);
  });

  // Warn on page leave if dirty
  window.addEventListener('beforeunload', function(e) {
    if (state.isDirty) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  // ============================================
  // Initialize
  // ============================================

  checkAuth();
})();
</script>

<style>
  .session-tracker {
    min-height: 80vh;
  }

  /* Auth Gate (same as player hub) */
  .auth-gate {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 70vh;
    padding: var(--space-xl);
  }

  .auth-content {
    text-align: center;
    max-width: 400px;
  }

  .auth-icon {
    color: var(--color-accent);
    margin-bottom: var(--space-lg);
  }

  .auth-title {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    color: var(--color-gold);
    margin: 0 0 var(--space-sm);
  }

  .auth-description {
    color: var(--color-text-secondary);
    margin: 0 0 var(--space-xl);
  }

  .auth-form {
    display: flex;
    gap: var(--space-sm);
  }

  .auth-input {
    flex: 1;
    padding: var(--space-md);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-secondary);
    color: var(--color-text);
    font-size: var(--text-base);
  }

  .auth-input:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .auth-btn {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-md) var(--space-lg);
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .auth-btn:hover {
    background: var(--color-accent-hover);
    transform: translateY(-1px);
  }

  .auth-error {
    color: var(--color-error);
    margin-top: var(--space-md);
    font-size: var(--text-sm);
  }

  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Tracker Content */
  .tracker-content {
    padding: var(--space-lg);
    max-width: 800px;
    margin: 0 auto;
  }

  .tracker-header {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-lg);
    border-bottom: 2px solid var(--color-gold);
  }

  .header-main {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-md);
  }

  .character-identity {
    flex: 1;
  }

  .tracker-title {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    color: var(--color-gold);
    margin: 0 0 var(--space-xs);
    text-shadow: 0 2px 10px rgba(180, 140, 60, 0.3);
    letter-spacing: 0.02em;
  }

  .character-details {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    align-items: center;
  }

  .character-level {
    background: var(--color-gold);
    color: var(--color-bg);
    padding: 2px 10px;
    border-radius: var(--radius-sm);
    font-size: var(--text-sm);
    font-weight: 700;
  }

  .character-class {
    color: var(--color-accent);
    font-weight: 600;
  }

  .character-race {
    color: var(--color-text-secondary);
  }

  .dashboard-nav {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
  }

  .nav-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    text-decoration: none;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .nav-link:hover {
    background: var(--color-bg-secondary);
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .nav-link--sheet:hover {
    border-color: var(--color-gold);
    color: var(--color-gold);
  }

  .draft-indicator {
    display: inline-flex;
    align-items: center;
  }

  .draft-badge {
    padding: 4px 12px;
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
  }

  .draft-badge--unsaved {
    background: var(--color-warning, #f59e0b);
    color: var(--color-bg);
  }

  .draft-badge--saving {
    background: var(--color-info, #3b82f6);
    color: white;
    animation: pulse-saving 1s ease-in-out infinite;
  }

  @keyframes pulse-saving {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .draft-badge--saved {
    background: var(--color-success, #10b981);
    color: white;
  }

  /* Sections - Card styling with depth */
  .section-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-family: var(--font-display);
    font-size: var(--text-lg);
    color: var(--color-gold);
    margin: 0 0 var(--space-lg);
    padding-bottom: var(--space-sm);
    border-bottom: 2px solid var(--color-gold);
  }

  .section-title svg {
    opacity: 0.8;
  }

  section {
    margin-bottom: var(--space-2xl);
    padding: var(--space-xl);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -2px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
    position: relative;
    transition: box-shadow 0.3s ease, transform 0.3s ease;
  }

  section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--color-gold) 0%, transparent 100%);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    opacity: 0.6;
  }

  section:hover {
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -4px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  /* HP Section */
  .hp-display {
    margin-bottom: var(--space-lg);
  }

  .hp-main {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
  }

  .hp-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 2px solid var(--color-border);
    background: var(--color-bg-tertiary);
    color: var(--color-text);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
  }

  .hp-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    pointer-events: none;
  }

  .hp-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .hp-btn:active {
    transform: translateY(0) scale(0.95);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .hp-btn--large {
    width: 52px;
    height: 52px;
    font-size: var(--text-sm);
  }

  .hp-btn--small {
    width: 36px;
    height: 36px;
    font-size: var(--text-xs);
  }

  /* Damage/heal button color hints */
  .hp-btn[data-change^="-"]:hover {
    border-color: var(--color-error);
    color: var(--color-error);
  }

  .hp-btn[data-change]:not([data-change^="-"]):hover {
    border-color: var(--color-success, #10b981);
    color: var(--color-success, #10b981);
  }

  .hp-value-container {
    display: flex;
    align-items: baseline;
    gap: var(--space-xs);
  }

  .hp-input {
    width: 80px;
    text-align: center;
    font-size: var(--text-3xl);
    font-weight: 700;
    font-family: var(--font-display);
    color: var(--color-accent);
    background: transparent;
    border: none;
    border-bottom: 2px solid var(--color-accent);
  }

  .hp-input:focus {
    outline: none;
  }

  .hp-separator {
    font-size: var(--text-xl);
    color: var(--color-text-muted);
  }

  .hp-max {
    font-size: var(--text-xl);
    color: var(--color-text-secondary);
  }

  .hp-bar {
    height: 16px;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    position: relative;
  }

  .hp-bar::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
    pointer-events: none;
  }

  .hp-bar-fill {
    height: 100%;
    background: linear-gradient(180deg, #34d399 0%, #10b981 50%, #059669 100%);
    transition: width 0.4s ease-out, background 0.3s ease;
    position: relative;
    box-shadow:
      0 0 12px rgba(16, 185, 129, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }

  .hp-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
    border-radius: inherit;
  }

  /* HP color states with glow effects */
  .hp-bar--critical .hp-bar-fill {
    background: linear-gradient(180deg, #f87171 0%, #ef4444 50%, #dc2626 100%);
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
    animation: hp-critical-pulse 1s ease-in-out infinite;
  }

  .hp-bar--warning .hp-bar-fill {
    background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
    box-shadow: 0 0 12px rgba(245, 158, 11, 0.4);
  }

  .hp-bar--healthy .hp-bar-fill {
    background: linear-gradient(180deg, #34d399 0%, #10b981 50%, #059669 100%);
    box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
  }

  @keyframes hp-critical-pulse {
    0%, 100% {
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
    }
    50% {
      box-shadow: 0 0 30px rgba(239, 68, 68, 0.9);
    }
  }

  .temp-hp-section {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
    padding: var(--space-md);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
  }

  .temp-hp-label {
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
  }

  .temp-hp-controls {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .temp-hp-input {
    width: 60px;
    text-align: center;
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--color-info, #3b82f6);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: var(--space-xs);
  }

  .quick-damage {
    display: flex;
    gap: var(--space-sm);
    justify-content: center;
    flex-wrap: wrap;
  }

  .damage-input {
    width: 100px;
    padding: var(--space-sm);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    text-align: center;
  }

  .damage-btn {
    padding: var(--space-sm) var(--space-lg);
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .damage-btn--hurt {
    background: var(--color-error);
    color: white;
  }

  .damage-btn--hurt:hover {
    background: #dc2626;
  }

  .damage-btn--heal {
    background: var(--color-success, #10b981);
    color: white;
  }

  .damage-btn--heal:hover {
    background: #059669;
  }

  /* Spell Slots - Magical themed */
  .spell-slots-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .slot-row {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--slot-color, var(--color-accent));
    transition: all var(--transition-fast);
  }

  .slot-row:hover {
    background: var(--color-bg);
  }

  /* Level-based slot colors - arcane energy spectrum */
  .slot-row[data-level="1"] { --slot-color: #60a5fa; }  /* Blue - foundational */
  .slot-row[data-level="2"] { --slot-color: #818cf8; }  /* Indigo */
  .slot-row[data-level="3"] { --slot-color: #a78bfa; }  /* Violet */
  .slot-row[data-level="4"] { --slot-color: #c084fc; }  /* Purple */
  .slot-row[data-level="5"] { --slot-color: #e879f9; }  /* Fuchsia */
  .slot-row[data-level="6"] { --slot-color: #f472b6; }  /* Pink */
  .slot-row[data-level="7"] { --slot-color: #fb7185; }  /* Rose */
  .slot-row[data-level="8"] { --slot-color: #f97316; }  /* Orange - powerful */
  .slot-row[data-level="9"] { --slot-color: #fbbf24; }  /* Gold - legendary */

  .slot-level {
    width: 80px;
    font-weight: 600;
    color: var(--slot-color, var(--color-text-secondary));
    font-size: var(--text-sm);
    text-shadow: 0 0 10px color-mix(in srgb, var(--slot-color) 30%, transparent);
  }

  .slot-pips {
    display: flex;
    gap: var(--space-sm);
    flex: 1;
  }

  .slot-pip {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid var(--slot-color, var(--color-accent));
    background: transparent;
    cursor: pointer;
    padding: 4px;
    transition: all 0.2s ease;
    position: relative;
  }

  .slot-pip:hover {
    transform: scale(1.15);
    box-shadow: 0 0 12px color-mix(in srgb, var(--slot-color) 50%, transparent);
  }

  .slot-pip:active {
    transform: scale(0.95);
  }

  .pip-fill {
    display: block;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: transparent;
    transition: all 0.2s ease;
  }

  .slot-pip--expended .pip-fill {
    background: var(--color-text-muted);
    opacity: 0.4;
  }

  .slot-pip:not(.slot-pip--expended) .pip-fill {
    background: var(--slot-color, var(--color-accent));
    box-shadow:
      0 0 8px color-mix(in srgb, var(--slot-color) 60%, transparent),
      inset 0 -2px 4px rgba(0, 0, 0, 0.2),
      inset 0 2px 4px rgba(255, 255, 255, 0.3);
    animation: slot-glow 2s ease-in-out infinite;
  }

  @keyframes slot-glow {
    0%, 100% {
      box-shadow:
        0 0 8px color-mix(in srgb, var(--slot-color) 40%, transparent),
        inset 0 -2px 4px rgba(0, 0, 0, 0.2),
        inset 0 2px 4px rgba(255, 255, 255, 0.3);
    }
    50% {
      box-shadow:
        0 0 16px color-mix(in srgb, var(--slot-color) 70%, transparent),
        inset 0 -2px 4px rgba(0, 0, 0, 0.2),
        inset 0 2px 4px rgba(255, 255, 255, 0.4);
    }
  }

  .slot-pip--pact {
    border-color: var(--color-gold);
    --slot-color: var(--color-gold);
  }

  .slot-count {
    width: 50px;
    text-align: right;
    font-weight: 700;
    color: var(--slot-color, var(--color-text-muted));
    font-size: var(--text-sm);
    font-variant-numeric: tabular-nums;
  }

  .pact-slots {
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px dashed var(--color-border);
  }

  .pact-slots .slot-row {
    border-left-color: var(--color-gold);
    background: linear-gradient(90deg, rgba(180, 140, 60, 0.1) 0%, transparent 100%);
  }

  /* Conditions - Enhanced badges */
  .conditions-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    min-height: 40px;
  }

  .no-conditions {
    color: var(--color-text-muted);
    font-style: italic;
    margin: 0;
    padding: var(--space-sm);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
    border: 1px dashed var(--color-border);
  }

  .condition-tag {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: 500;
    box-shadow:
      0 2px 8px rgba(239, 68, 68, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all var(--transition-fast);
    animation: condition-appear 0.3s ease-out;
  }

  @keyframes condition-appear {
    from {
      opacity: 0;
      transform: scale(0.8) translateY(-4px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .condition-tag:hover {
    transform: translateY(-2px);
    box-shadow:
      0 4px 12px rgba(239, 68, 68, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }

  .condition-tag--beneficial {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    box-shadow:
      0 2px 8px rgba(16, 185, 129, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.15);
  }

  .condition-tag--beneficial:hover {
    box-shadow:
      0 4px 12px rgba(16, 185, 129, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }

  .concentration-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 50%;
    font-size: 11px;
    font-weight: 700;
    border: 1px solid rgba(255, 255, 255, 0.3);
    animation: concentration-pulse 2s ease-in-out infinite;
  }

  @keyframes concentration-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .condition-name {
    font-weight: 600;
    letter-spacing: 0.025em;
  }

  .condition-source {
    font-size: var(--text-xs);
    opacity: 0.75;
    font-style: italic;
  }

  .condition-remove {
    background: rgba(255, 255, 255, 0.15);
    border: none;
    color: white;
    font-size: var(--text-base);
    cursor: pointer;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    opacity: 0.8;
    transition: all var(--transition-fast);
    margin-left: var(--space-xs);
  }

  .condition-remove:hover {
    opacity: 1;
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
  }

  .add-condition {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    align-items: center;
  }

  .condition-select {
    flex: 1;
    min-width: 200px;
    padding: var(--space-sm);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
  }

  .custom-condition-input {
    flex: 1;
    min-width: 200px;
    padding: var(--space-sm);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
  }

  .concentration-checkbox,
  .beneficial-checkbox {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    cursor: pointer;
  }

  .add-condition-btn {
    padding: var(--space-sm) var(--space-lg);
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .add-condition-btn:hover {
    background: var(--color-accent-hover);
  }

  /* Rest Section - Thematic buttons */
  .rest-buttons {
    display: flex;
    gap: var(--space-xl);
    justify-content: center;
    flex-wrap: wrap;
  }

  .rest-btn {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-lg) var(--space-2xl);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-lg);
    background: var(--color-bg);
    color: var(--color-text);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .rest-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .rest-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .rest-btn:active {
    transform: translateY(-1px);
  }

  .rest-btn--short::before {
    background: radial-gradient(circle at 50% 120%, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
  }

  .rest-btn--short:hover {
    border-color: var(--color-info, #3b82f6);
    color: var(--color-info, #3b82f6);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
  }

  .rest-btn--short:hover::before {
    opacity: 1;
  }

  .rest-btn--short svg {
    transition: transform 0.6s ease;
  }

  .rest-btn--short:hover svg {
    transform: rotate(180deg);
  }

  .rest-btn--long::before {
    background: radial-gradient(circle at 50% 120%, rgba(180, 140, 60, 0.15) 0%, transparent 70%);
  }

  .rest-btn--long:hover {
    border-color: var(--color-gold);
    color: var(--color-gold);
    box-shadow: 0 8px 25px rgba(180, 140, 60, 0.25);
  }

  .rest-btn--long:hover::before {
    opacity: 1;
  }

  .rest-btn--long svg {
    transition: transform 0.6s ease;
  }

  .rest-btn--long:hover svg {
    transform: scale(1.2);
  }

  /* Footer */
  .tracker-footer {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border);
    flex-wrap: wrap;
  }

  .save-btn {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-xl);
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .save-btn:hover {
    background: var(--color-accent-hover);
    transform: translateY(-1px);
  }

  .save-status {
    flex: 1;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .save-status--success {
    color: var(--color-success, #10b981);
  }

  .save-status--error {
    color: var(--color-error);
  }

  .logout-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .logout-btn:hover {
    border-color: var(--color-error);
    color: var(--color-error);
  }

  /* Features Section */
  .features-section {
    background: linear-gradient(135deg, var(--color-bg-secondary) 0%, rgba(180, 140, 60, 0.05) 100%);
  }

  .features-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .feature-row {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--color-gold);
    transition: all var(--transition-fast);
  }

  .feature-row:hover {
    background: var(--color-bg);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .feature-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .feature-name {
    font-weight: 600;
    color: var(--color-gold);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .feature-recharge {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .feature-recharge--short-rest {
    color: var(--color-info, #3b82f6);
  }

  .feature-recharge--long-rest {
    color: var(--color-accent);
  }

  .feature-pips {
    display: flex;
    gap: var(--space-sm);
  }

  .feature-pip {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid var(--color-gold);
    background: transparent;
    cursor: pointer;
    padding: 4px;
    transition: all 0.2s ease;
  }

  .feature-pip:hover {
    transform: scale(1.15);
    box-shadow: 0 0 12px rgba(180, 140, 60, 0.4);
  }

  .feature-pip .pip-fill {
    display: block;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: var(--color-gold);
    box-shadow:
      0 0 8px rgba(180, 140, 60, 0.5),
      inset 0 -2px 4px rgba(0, 0, 0, 0.2),
      inset 0 2px 4px rgba(255, 255, 255, 0.3);
    transition: all 0.2s ease;
  }

  .feature-pip--used .pip-fill {
    background: var(--color-text-muted);
    opacity: 0.3;
    box-shadow: none;
  }

  .feature-count {
    width: 45px;
    text-align: right;
    font-weight: 700;
    color: var(--color-gold);
    font-size: var(--text-sm);
    font-variant-numeric: tabular-nums;
  }

  /* Death Saves Section */
  .death-saves-section {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, var(--color-bg-secondary) 100%);
    border: 2px solid var(--color-error);
    animation: death-saves-appear 0.3s ease-out;
  }

  @keyframes death-saves-appear {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .section-title--danger {
    color: var(--color-error);
    border-bottom-color: var(--color-error);
  }

  .death-saves-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
  }

  .death-saves-row {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    padding: var(--space-md);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
  }

  .death-saves-label {
    width: 100px;
    font-weight: 600;
    font-size: var(--text-sm);
  }

  .death-saves-label--success {
    color: var(--color-success, #10b981);
  }

  .death-saves-label--failure {
    color: var(--color-error);
  }

  .death-saves-pips {
    display: flex;
    gap: var(--space-md);
    flex: 1;
    justify-content: center;
  }

  .death-pip {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 3px solid var(--color-success, #10b981);
    background: transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .death-pip--failure {
    border-color: var(--color-error);
  }

  .death-pip:hover {
    transform: scale(1.15);
  }

  .death-pip .pip-marker {
    font-size: 24px;
    color: transparent;
    transition: color 0.2s ease;
  }

  .death-pip--filled .pip-marker {
    color: var(--color-success, #10b981);
    text-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
  }

  .death-pip--failure.death-pip--filled .pip-marker {
    color: var(--color-error);
    text-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
  }

  .death-saves-count {
    width: 50px;
    text-align: right;
    font-weight: 700;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .death-saves-actions {
    display: flex;
    gap: var(--space-md);
    justify-content: center;
    flex-wrap: wrap;
  }

  .death-action-btn {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-lg);
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
  }

  .death-action-btn--success {
    background: var(--color-success, #10b981);
    color: white;
  }

  .death-action-btn--success:hover {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .death-action-btn--failure {
    background: var(--color-error);
    color: white;
  }

  .death-action-btn--failure:hover {
    background: #dc2626;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }

  .death-action-btn--stabilize {
    background: var(--color-gold);
    color: var(--color-bg);
  }

  .death-action-btn--stabilize:hover {
    background: #c9a227;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(180, 140, 60, 0.3);
  }

  @media (max-width: 640px) {
    .tracker-content {
      padding: var(--space-md);
    }

    .hp-main {
      flex-wrap: wrap;
    }

    .slot-row {
      flex-wrap: wrap;
    }

    .slot-level {
      width: 100%;
    }

    .add-condition {
      flex-direction: column;
    }

    .condition-select,
    .custom-condition-input {
      width: 100%;
    }

    .tracker-footer {
      flex-direction: column;
      align-items: stretch;
    }

    .save-btn {
      justify-content: center;
    }

    .logout-btn {
      justify-content: center;
    }

    .dashboard-nav {
      flex-direction: column;
    }
  }

  /* Party Modal */
  .party-modal {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-lg);
  }

  .party-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .party-modal-content {
    position: relative;
    width: 100%;
    max-width: 500px;
    max-height: 80vh;
    background: var(--color-bg);
    border: 2px solid var(--color-gold);
    border-radius: var(--radius-lg);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .party-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .party-modal-header h2 {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    color: var(--color-gold);
    margin: 0;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: var(--text-2xl);
    color: var(--color-text-muted);
    cursor: pointer;
    padding: var(--space-xs);
    line-height: 1;
    transition: color var(--transition-fast);
  }

  .modal-close:hover {
    color: var(--color-error);
  }

  .party-modal-body {
    padding: var(--space-lg);
    overflow-y: auto;
  }

  .party-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .party-member {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    transition: all var(--transition-fast);
  }

  .party-member:hover {
    border-color: var(--color-accent);
    transform: translateX(4px);
  }

  .party-member--current {
    border-color: var(--color-success);
    background: rgba(16, 185, 129, 0.1);
  }

  .party-member--current:hover {
    border-color: var(--color-success);
  }

  .party-member-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .party-member-name {
    font-weight: 600;
    color: var(--color-gold);
  }

  .party-member-details {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .current-badge {
    background: var(--color-success);
    color: white;
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
  }
</style>
