---
/**
 * OAuth Callback Page
 * Handles the redirect from Cognito hosted UI after authentication.
 * Exchanges the authorization code for tokens and redirects to the return URL.
 */

import BaseLayout from '@layouts/BaseLayout.astro';
---

<BaseLayout
  title="Signing in... - Rudiger's Evocation of Events"
  description="Completing authentication"
>
  <div class="callback-container">
    <div class="callback-content">
      <div class="spinner"></div>
      <h1 class="callback-title">Signing in...</h1>
      <p id="callback-status" class="callback-status">Completing authentication</p>
      <p id="callback-error" class="callback-error" style="display: none;"></p>
      <a id="callback-retry" href="/campaign" class="callback-retry" style="display: none;">
        Return to Player Hub
      </a>
    </div>
  </div>
</BaseLayout>

<script>
  import { exchangeCodeForTokens, isSsoAvailable } from '@lib/auth';

  async function handleCallback() {
    const statusEl = document.getElementById('callback-status');
    const errorEl = document.getElementById('callback-error');
    const retryEl = document.getElementById('callback-retry');

    function showError(message: string) {
      if (statusEl) statusEl.style.display = 'none';
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
      if (retryEl) retryEl.style.display = 'inline-block';
      // Hide spinner
      const spinner = document.querySelector('.spinner');
      if (spinner) (spinner as HTMLElement).style.display = 'none';
    }

    // Parse URL parameters
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    const error = params.get('error');
    const errorDescription = params.get('error_description');
    const state = params.get('state'); // Contains return URL

    // Handle OAuth errors from Cognito
    if (error) {
      showError(errorDescription || `Authentication error: ${error}`);
      return;
    }

    // Check for authorization code
    if (!code) {
      showError('No authorization code received. Please try signing in again.');
      return;
    }

    // Check if SSO is configured
    if (!isSsoAvailable()) {
      showError('Single sign-on is not configured. Please use token authentication.');
      return;
    }

    try {
      // Exchange code for tokens
      if (statusEl) statusEl.textContent = 'Exchanging authorization code...';
      
      await exchangeCodeForTokens(code);

      // Success - redirect to return URL or campaign index
      if (statusEl) statusEl.textContent = 'Success! Redirecting...';
      
      const returnUrl = state ? decodeURIComponent(state) : '/campaign';
      // Validate return URL is relative (prevent open redirect)
      const safeUrl = returnUrl.startsWith('/') ? returnUrl : '/campaign';
      
      window.location.href = safeUrl;
    } catch (err) {
      console.error('Token exchange failed:', err);
      showError('Failed to complete sign-in. Please try again.');
    }
  }

  // Run on page load
  handleCallback();
</script>

<style>
  .callback-container {
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-xl);
  }

  .callback-content {
    text-align: center;
    max-width: 400px;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--color-bg-tertiary);
    border-top-color: var(--color-gold);
    border-radius: 50%;
    margin: 0 auto var(--space-lg);
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .callback-title {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    color: var(--color-gold);
    margin: 0 0 var(--space-md);
  }

  .callback-status {
    color: var(--color-text-secondary);
    margin: 0;
  }

  .callback-error {
    color: var(--color-accent);
    background: rgba(var(--color-accent-rgb, 192, 86, 86), 0.1);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    margin: var(--space-md) 0 0;
  }

  .callback-retry {
    display: inline-block;
    margin-top: var(--space-lg);
    padding: var(--space-sm) var(--space-lg);
    background: var(--color-gold);
    color: var(--color-bg);
    text-decoration: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    transition: all var(--transition-fast);
  }

  .callback-retry:hover {
    background: var(--color-gold-light);
  }
</style>
