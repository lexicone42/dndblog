---
/**
 * Login Page
 * Redirects to Cognito hosted UI for authentication.
 * This is a simple redirect page - SSO handles the actual login flow.
 */

import BaseLayout from '@layouts/BaseLayout.astro';
---

<BaseLayout
  title="Sign In - Rudiger's Evocation of Events"
  description="Sign in to access your campaign dashboard"
>
  <div class="login-container">
    <div class="login-content">
      <div class="spinner"></div>
      <h1 class="login-title">Redirecting to Sign In...</h1>
      <p id="login-status" class="login-status">Preparing authentication</p>
      <p id="login-error" class="login-error" style="display: none;"></p>
      <a id="login-fallback" href="/" class="login-fallback" style="display: none;">
        Return Home
      </a>
    </div>
  </div>
</BaseLayout>

<script>
  import { getLoginUrl, isSsoAvailable, getAuthState } from '@lib/auth';

  function handleLogin() {
    const statusEl = document.getElementById('login-status');
    const errorEl = document.getElementById('login-error');
    const fallbackEl = document.getElementById('login-fallback');

    function showError(message: string) {
      const spinner = document.querySelector('.spinner');
      if (spinner) (spinner as HTMLElement).style.display = 'none';
      if (statusEl) statusEl.style.display = 'none';
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
      if (fallbackEl) fallbackEl.style.display = 'inline-block';
    }

    // Check if already logged in
    const auth = getAuthState();
    if (auth) {
      if (statusEl) statusEl.textContent = 'Already signed in, redirecting...';
      // Get return URL from query params or default to /me
      const params = new URLSearchParams(window.location.search);
      const returnUrl = params.get('return') || '/me';
      const safeUrl = returnUrl.startsWith('/') ? returnUrl : '/me';
      window.location.href = safeUrl;
      return;
    }

    // Check if SSO is available
    if (!isSsoAvailable()) {
      showError('Single sign-on is not configured for this site.');
      return;
    }

    // Get return URL from query params
    const params = new URLSearchParams(window.location.search);
    const returnUrl = params.get('return') || '/me';

    // Redirect to Cognito hosted UI
    if (statusEl) statusEl.textContent = 'Redirecting to sign in...';
    window.location.href = getLoginUrl(returnUrl);
  }

  // Run on page load
  handleLogin();
</script>

<style>
  .login-container {
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-xl);
  }

  .login-content {
    text-align: center;
    max-width: 400px;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--color-bg-tertiary);
    border-top-color: var(--color-gold);
    border-radius: 50%;
    margin: 0 auto var(--space-lg);
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .login-title {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    color: var(--color-gold);
    margin: 0 0 var(--space-md);
  }

  .login-status {
    color: var(--color-text-secondary);
    margin: 0;
  }

  .login-error {
    color: var(--color-accent);
    background: rgba(var(--color-accent-rgb, 192, 86, 86), 0.1);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    margin: var(--space-md) 0 0;
  }

  .login-fallback {
    display: inline-block;
    margin-top: var(--space-lg);
    padding: var(--space-sm) var(--space-lg);
    background: var(--color-gold);
    color: var(--color-bg);
    text-decoration: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    transition: all var(--transition-fast);
  }

  .login-fallback:hover {
    background: var(--color-gold-light);
  }
</style>
